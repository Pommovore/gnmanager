{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Événements</h3>
    <div class="d-flex gap-2">
        <form action="{{ url_for('admin.dashboard') }}" method="GET" class="d-flex align-items-center">
            <select name="filter" class="form-select me-2" onchange="this.form.submit()">
                <option value="all" {% if current_filter=='all' %}selected{% endif %}>Tous les Événements</option>
                <option value="mine" {% if current_filter=='mine' %}selected{% endif %}>Mes Événements</option>
                <option value="future" {% if current_filter=='future' %}selected{% endif %}>Événements à venir</option>
                <option value="past" {% if current_filter=='past' %}selected{% endif %}>Événements passés</option>
            </select>
        </form>
        <a href="{{ url_for('event.create_event') }}" class="btn btn-primary">Créer</a>
    </div>
</div>

<div class="d-flex flex-column gap-2">
    {% for e in events %}
    {% set participation = my_roles.get(e.id) %}
    {% set row_class = "" %}
    {% set badge_class = "" %}
    {% set badge_text = "" %}

    {% if participation %}
    {% if participation.registration_status == 'En attente' or participation.registration_status == 'À valider' %}
    {% set row_class = "list-group-item-secondary" %}
    {% set badge_class = "bg-light text-dark border" %}
    {% set badge_text = participation.type ~ " (En Attente)" %}
    {% elif participation.is_organizer %}
    {% set row_class = "list-group-item-danger" %}
    {% set badge_class = "bg-danger" %}
    {% set badge_text = "Organisateur" %}
    {% elif participation.is_pj %}
    {% set row_class = "list-group-item-success" %}
    {% set badge_class = "bg-success" %}
    {% set badge_text = "PJ" %}
    {% elif participation.is_pnj %}
    {% set row_class = "list-group-item-primary" %}
    {% set badge_class = "bg-primary" %}
    {% set badge_text = "PNJ" %}
    {% else %}
    {% set row_class = "list-group-item-success" %}
    {% set badge_class = "bg-success" %}
    {% set badge_text = participation.type %}
    {% endif %}
    {% endif %}

    {% set status_color = "bg-secondary" %}
    {% if e.statut == "Événement en cours" %}
    {% set status_color = "bg-success" %}
    {% elif e.statut == "Terminé" %}
    {% set status_color = "bg-dark" %}
    {% elif e.statut == "Annulé" %}
    {% set status_color = "bg-danger" %}
    {% elif e.statut == "En préparation" %}
    {% set status_color = "bg-info text-dark" %}
    {% elif e.statut == "Inscriptions ouvertes" %}
    {% set status_color = "bg-success" %}
    {% endif %}

    <style>
        .association-medallion {
            background-color: rgba(197, 160, 40, 0.1);
            border: 1px solid #C5A028;
            color: #a68a2d;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-top: 5px;
            font-weight: 500;
        }

        [data-bs-theme="dark"] .association-medallion {
            background-color: rgba(197, 160, 40, 0.05);
            color: #d4af37;
        }

        [data-bs-theme="light"] .association-medallion {
            background-color: rgba(197, 160, 40, 0.05);
            color: #8a6d07;
        }
    </style>

    <a href="{{ url_for('event.detail', event_id=e.id) }}"
        class="list-group-item list-group-item-action border rounded shadow-sm p-3 {{ row_class }}">
        <div class="d-flex w-100 justify-content-between align-items-center">
            <h5 class="mb-1">
                {{ e.name }}
                <span class="badge {{ status_color }}">{{ e.statut }}</span>
                {% if participation %}
                <span class="badge {{ badge_class }} ms-2">{{ badge_text }}
                    {% if (participation.registration_status != 'En attente' and participation.registration_status != 'À
                    valider') and participation.group and participation.group != 'Peu importe' %}
                    - {{ participation.group }}
                    {% endif %}
                </span>
                {% endif %}
            </h5>
            <small class="text-muted">
                <i class="bi bi-calendar-range me-1"></i>
                Du {{ e.date_start.strftime('%d/%m/%Y') }} au {{ e.date_end.strftime('%d/%m/%Y') }}
            </small>
        </div>
        <div class="mt-2 text-muted small">
            Par :
            <span class="association-medallion">
                {{ e.organizing_association or 'une entité mystérieuse et inquiétante' }}
            </span>
            à {{ e.location }}
        </div>
    </a>
    {% else %}
    <p class="text-muted text-center mt-4">Aucun événement trouvé pour ce filtre.</p>
    {% endfor %}
</div>
{% endblock %}