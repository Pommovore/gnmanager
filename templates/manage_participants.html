{% extends "base.html" %}
{% block content %}
<form method="POST" action="/event/{{ event.id }}/participants/bulk_update">
    <button type="submit" class="btn btn-primary mb-3">Enregistrement et retour à l'événement</button>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Statut</th>
                    <th>Type</th>
                    <th>Groupe</th>
                    <th>Paiement</th>
                    <th>Commentaire</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in participants %}
                <tr
                    class="{{ 'table-warning' if p.registration_status == 'À valider' else 'table-danger' if p.registration_status == 'Rejeté' else '' }}">
                    <input type="hidden" name="participant_ids" value="{{ p.id }}">
                    <!-- Use arrays or prefixed names. Easiest with parallel arrays if ordering preserved, but safety with ID is better.
                     Let's use p_id in name: name="status_{{p.id}}" 
                     BUT to process efficiently, we can iterate over IDs in backend.
                     Let's use consistent naming: status_{{p.id}}, type_{{p.id}}, group_{{p.id}}, ..
                -->
                    <td>{{ p.user.nom }} {{ p.user.prenom }}</td>
                    <td>{{ p.user.email }}</td>
                    <td>
                        <select name="status_{{ p.id }}"
                            class="form-select form-select-sm {{ 'border-danger' if p.registration_status=='Rejeté' else 'border-success' if p.registration_status=='Validé' else 'border-warning' }}">
                            <option value="À valider" {% if p.registration_status=='À valider' %}selected{% endif %}>À
                                valider</option>
                            <option value="En attente" {% if p.registration_status=='En attente' %}selected{% endif %}>
                                En attente</option>
                            <option value="Validé" {% if p.registration_status=='Validé' %}selected{% endif %}>Validé
                            </option>
                            <option value="Rejeté" {% if p.registration_status=='Rejeté' %}selected{% endif %}>Rejeté
                            </option>
                        </select>
                    </td>
                    <td>
                        <select name="type_{{ p.id }}" class="form-select form-select-sm">
                            <option value="organisateur" {% if p.type=='organisateur' %}selected{% endif %}>Organisateur
                            </option>
                            <option value="PJ" {% if p.type=='PJ' %}selected{% endif %}>PJ</option>
                            <option value="PNJ" {% if p.type=='PNJ' %}selected{% endif %}>PNJ</option>
                        </select>
                    </td>
                    <td>
                        <select name="group_{{ p.id }}" class="form-select form-select-sm">
                            <!-- Logic to show correct groups based on participant type is tricky in pure Jinja if we want dynamic switching on type change. 
                                 However, for managing existing participants, the type is fixed unless changed.
                                 If type is changed in the row, group options should ideally update (JS needed).
                                 For MVP, let's show ALL groups or just distinct ones? Or simple input for now?
                                 Spec says: "l'attribution des groupes doit passer par menu déroulant"
                                 Let's use a Select that shows groups for the CURRENT type of the participant.
                            -->
                            {% set p_groups = groups_config.get(p.type, ['Peu importe']) %}
                            <!-- Fallback if type casing differs e.g. 'organisateur' vs 'Organisateur' in config -->
                            {% if p.type == 'organisateur' %}{% set p_groups = groups_config.get('Organisateur', ['Peu
                            importe']) %}{% endif %}

                            {% for g in p_groups %}
                            <option value="{{ g }}" {% if p.group==g %}selected{% endif %}>{{ g }}</option>
                            {% endfor %}
                            <option value="Autre" {% if p.group not in p_groups %}selected{% endif %}>Autre/Custom
                            </option>
                        </select>
                        <!-- Keep custom value if not in list via JS? Or just let them save whatever -->
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" step="0.01" name="pay_amount_{{ p.id }}" value="{{ p.payment_amount }}"
                                class="form-control">
                            <input type="text" name="pay_method_{{ p.id }}" value="{{ p.payment_method or '' }}"
                                class="form-control" placeholder="Moyen">
                        </div>
                    </td>
                    <td><textarea name="comment_{{ p.id }}"
                            class="form-control form-control-sm">{{ p.comment or '' }}</textarea>
                    </td>
                    <td>
                        <!-- No individual save button -->
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endblock %}