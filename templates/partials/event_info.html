{# Event information card - extracted from event_detail.html #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/event_info.css') }}">
<style>
    /* Dynamic background images - must remain inline due to template variables */
    [data-bs-theme="light"] #event-info-card {
        background-image: url("{{ url_for('static', filename=event.background_image_light if event.background_image_light else 'fond_clair.jpg') }}");
    }

    [data-bs-theme="dark"] #event-info-card {
        background-image: url("{{ url_for('static', filename=event.background_image_dark if event.background_image_dark else 'fond_sombre.jpg') }}");
    }
</style>

<div class="card mb-4" id="event-info-card">
    <div class="card-body">
        {% if is_organizer %}
        {% set other_orgs = [] %}
        {% for p in event.participants if p.is_organizer and p.registration_status == 'Validé' and p.user_id !=
        current_user.id %}
        {% set _ = other_orgs.append(p.user.prenom ~ ' ' ~ p.user.nom) %}
        {% endfor %}
        <div class="organizer-box">
            Vous êtes organisateur de cet événement{% if other_orgs %} avec {{ other_orgs|join(', ') }}{% endif %}.
        </div>
        {% endif %}

        {# 1. Titre #}
        <h1 class="card-title">{{ event.name }}</h1>
        <div class="text-muted mb-3">
            <p class="mb-0">organisé par : {{ event.organizing_association or 'une entité mystérieuse et inquiétante' }}
            </p>
            {% if event.display_organizers and not is_organizer %}
            {% set all_validated_orgs = [] %}
            {% for p in event.participants if p.is_organizer and p.registration_status == 'Validé' %}
            {% set _ = all_validated_orgs.append(p.user.prenom ~ ' ' ~ p.user.nom) %}
            {% endfor %}
            {% if all_validated_orgs %}
            <p class="mb-0 small">organisateurs : {{ all_validated_orgs|join(', ') }}</p>
            {% endif %}
            {% endif %}
        </div>

        {# 2. Date #}
        <p class="text-muted">
            Du {{ event.date_start.strftime('%d/%m/%Y') }} au {{ event.date_end.strftime('%d/%m/%Y') }}<br>
            {{ event.location }}
        </p>

        {# 3. Description #}
        <p class="mt-3">{{ event.description }}</p>

        {# 4. Statut Actuel #}
        {% set status_badge_class = 'bg-info' %}
        {% if event.statut == 'Inscriptions ouvertes' or event.statut == 'Événement en cours' %}
        {% set status_badge_class = 'bg-success' %}
        {% elif event.statut == 'Annulé' %}
        {% set status_badge_class = 'bg-danger' %}
        {% elif event.statut == 'Terminé' %}
        {% set status_badge_class = 'bg-dark' %}
        {% endif %}
        <p>Status actuel de l'événement : <span class="badge {{ status_badge_class }}">{{ event.statut }}</span></p>

        <div class="d-flex flex-wrap gap-2 mb-3">
            {% for link in event.links_sorted %}
            <a href="{{ link.url }}" target="_blank" class="btn btn-outline-secondary text-white">
                <i class="bi bi-link-45deg"></i> {{ link.title }}
            </a>
            {% else %}
            {# Fallback for potential legacy data if migration issue, though migration script should cover it #}
            {% if event.org_link_url %}
            <a href="{{ event.org_link_url }}" target="_blank" class="btn btn-outline-secondary text-white">
                <i class="bi bi-link-45deg"></i> {{ event.org_link_title or 'Lien externe' }}
            </a>
            {% endif %}
            {% endfor %}
        </div>

        {# 5. Statut Utilisateur / Boutons #}
        {% if participant %}
        {# Cas: Utilisateur participe déjà #}
        {% if participant.type %}
        {% set badge_class = "bg-secondary" %}
        {% if participant.is_organizer %}
        {% set badge_class = "bg-danger" %}
        {% elif participant.is_pj %}
        {% set badge_class = "bg-success" %}
        {% elif participant.is_pnj %}
        {% set badge_class = "bg-primary" %}
        {% endif %}

        {# Logique couleurs badges #}
        {% set reg_class = "bg-secondary" %}
        {% if participant.registration_status == 'Validé' %}{% set reg_class = "bg-success" %}
        {% elif participant.registration_status == 'Rejeté' %}{% set reg_class = "bg-danger" %}
        {% elif participant.registration_status in ['En attente', 'À valider'] %}{% set reg_class = "bg-warning
        text-dark" %}
        {% endif %}

        {% set paf_class = "bg-secondary" %}
        {% if participant.paf_status == 'versée' %}{% set paf_class = "bg-success" %}
        {% elif participant.paf_status == 'partielle' %}{% set paf_class = "bg-warning text-dark" %}
        {% elif participant.paf_status == 'non versée' %}{% set paf_class = "bg-danger" %}
        {% endif %}

        <div class="border border-3 rounded p-3 mt-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="bi bi-person-check-fill me-2"></i>Ma participation</h6>
                <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                    data-bs-target="#leaveEventModal">
                    <i class="bi bi-box-arrow-right"></i> Quitter l'événement
                </button>
            </div>

            <p class="mb-1">
                <strong>Mon rôle :</strong>
                <span class="badge {{ badge_class }} ms-2">
                    {{ participant.type }}
                    {% if participant.group and participant.group != 'Peu importe' %}
                    - {{ participant.group }}
                    {% endif %}
                </span>
                {% if assigned_role %}
                <span class="badge bg-dark ms-2">{{ assigned_role.name }}</span>
                {% endif %}
            </p>
            {% if assigned_role %}
            <p class="mb-1">
                <i class="bi bi-arrow-right text-primary"></i>
                <strong class="ms-1">Ma fiche de personnage :</strong>
                {% if assigned_role.pdf_url %}
                <a href="{{ assigned_role.pdf_url }}" target="_blank" class="ms-1">
                    <i class="bi bi-file-pdf text-danger"></i> Télécharger le PDF
                </a>
                {% else %}
                <span class="text-muted ms-1 fst-italic">bientôt disponible...</span>
                {% endif %}
            </p>
            {% endif %}
            <p class="mb-1">
                <strong>Status de mon inscription :</strong>
                <span class="badge {{ reg_class }} ms-2">{{ participant.registration_status }}</span>
            </p>
            <p class="mb-0">
                <strong>Status de ma PAF :</strong>
                <span class="badge {{ paf_class }} ms-2">{{ participant.paf_status }}</span>
            </p>

            <!-- Section Mes Coordonnées -->
            <div class="mt-3 pt-3 border-top">
                <h6 class="mb-3"><i class="bi bi-person-lines-fill me-2"></i>Mes Coordonnées</h6>

                <!-- Email (read-only) -->
                <p class="mb-2">
                    <strong>Mon email :</strong>
                    <span class="badge bg-secondary ms-2">{{ current_user.email }}</span>
                </p>

                <!-- Facebook -->
                <p class="mb-2 d-flex align-items-center">
                    <strong>Mon Facebook :</strong>
                    {% if participant.participant_facebook %}
                    <a href="{{ participant.participant_facebook }}" target="_blank" class="ms-2 text-decoration-none">
                        <i class="bi bi-facebook text-primary"></i> Voir mon profil
                    </a>
                    {% else %}
                    <span class="badge bg-danger ms-2">Non fourni</span>
                    {% endif %}
                    <button type="button" class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal"
                        data-bs-target="#editFacebookModal">
                        <i class="bi bi-gear-fill text-secondary"></i>
                    </button>
                </p>

                <!-- Discord -->
                <p class="mb-2 d-flex align-items-center">
                    <strong>Mon Discord :</strong>
                    {% if participant.participant_discord %}
                    <span class="ms-2 text-primary">
                        <i class="bi bi-discord"></i> {{ participant.participant_discord }}
                    </span>
                    {% else %}
                    <span class="badge bg-danger ms-2">Non fourni</span>
                    {% endif %}
                    <button type="button" class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal"
                        data-bs-target="#editDiscordModal">
                        <i class="bi bi-gear-fill text-secondary"></i>
                    </button>
                </p>

                <!-- Téléphone -->
                <p class="mb-0 d-flex align-items-center">
                    <strong>Mon Téléphone :</strong>
                    {% if participant.participant_phone %}
                    <a href="tel:{{ participant.participant_phone }}" class="ms-2 text-decoration-none">
                        <i class="bi bi-smartphone text-success"></i> {{ participant.participant_phone }}
                    </a>
                    {% else %}
                    <span class="badge bg-danger ms-2">Non fourni</span>
                    {% endif %}
                    <button type="button" class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal"
                        data-bs-target="#editPhoneModal">
                        <i class="bi bi-gear-fill text-secondary"></i>
                    </button>
                </p>
            </div>

            <!-- Section Ma Photo -->
            <div class="photo-section">
                <h6 class="mb-3"><i class="bi bi-camera-fill me-2"></i>Ma Photo</h6>

                <div class="photo-frames-container">
                    <!-- Cadre 1 : Photo Générale -->
                    <div class="photo-frame-wrapper">
                        <strong class="mb-2">Ma photo générale</strong>
                        <div class="photo-frame" title="Photo de profil actuelle">
                            {% if current_user.profile_photo_url %}
                            <img src="{{ url_for('static', filename=current_user.profile_photo_url.replace('/static/', '')) }}"
                                alt="Photo de profil">
                            {% else %}
                            <div class="text-muted text-center p-2">
                                <i class="bi bi-person-fill fs-1"></i><br>
                                <div class="text-center p-3">
                                    Pas de photo : vous pouvez ajouter votre photo de profil dans l'écran de préférences
                                    accessible via <i class="bi bi-gear-fill"></i> en haut de l'écran
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Boutons Copier dans les deux sens -->
                    <div class="photo-action-btn d-flex flex-column" style="gap: 50px !important;">
                        <!-- Profil vers Event (L2R) -->
                        <form
                            action="{{ url_for('participant.copy_profile_to_event_photo', event_id=event.id, participant_id=participant.id) }}"
                            method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            {% if not current_user.profile_photo_url or participant.custom_image or
                            participant.is_photo_locked %}
                            <!-- Disabled State -->
                            <button type="button" class="btn p-0 border-0" disabled
                                title="{% if participant.is_photo_locked %}Photo verrouillée{% else %}Action indisponible{% endif %}">
                                <img src="{{ url_for('static', filename='assets/copier_L2R_grise.png') }}"
                                    alt="Copier vers l'événement (Désactivé)" style="width: 100px;">
                            </button>
                            {% else %}
                            <!-- Enabled State -->
                            <button type="submit" class="btn p-0 border-0 bg-transparent"
                                title="Utiliser ma photo de profil pour cet événement">
                                <img src="{{ url_for('static', filename='assets/copier_L2R_icone.png') }}"
                                    onmouseover="this.src='{{ url_for('static', filename='assets/copier_L2R_copier.png') }}';"
                                    onmouseout="this.src='{{ url_for('static', filename='assets/copier_L2R_icone.png') }}';"
                                    alt="Copier vers l'événement" style="width: 100px;">
                            </button>
                            {% endif %}
                        </form>

                        <!-- Event vers Profil (R2L) -->
                        <form
                            action="{{ url_for('participant.copy_event_to_profile_photo', event_id=event.id, participant_id=participant.id) }}"
                            method="POST"
                            onsubmit="return confirm('Attention : Cette action va remplacer votre photo de profil générale par celle de cet événement. Continuer ?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            {% if not participant.custom_image %}
                            <!-- Disabled State -->
                            <button type="button" class="btn p-0 border-0" disabled
                                title="Aucune photo d'événement à copier">
                                <img src="{{ url_for('static', filename='assets/copier_R2L_grise.png') }}"
                                    alt="Copier vers le profil (Désactivé)" style="width: 100px;">
                            </button>
                            {% else %}
                            <!-- Enabled State -->
                            <button type="submit" class="btn p-0 border-0 bg-transparent"
                                title="Définir cette photo comme ma photo de profil générale">
                                <img src="{{ url_for('static', filename='assets/copier_R2L_icone.png') }}"
                                    onmouseover="this.src='{{ url_for('static', filename='assets/copier_R2L_copier.png') }}';"
                                    onmouseout="this.src='{{ url_for('static', filename='assets/copier_R2L_icone.png') }}';"
                                    alt="Copier vers le profil" style="width: 100px;">
                            </button>
                            {% endif %}
                        </form>
                    </div>

                    <!-- Cadre 2 : Photo Événement -->
                    <div class="photo-frame-wrapper">
                        <strong class="mb-2">Ma photo pour {{ event.name }}</strong>

                        {% if participant.is_photo_locked %}
                        <div class="photo-frame border-danger position-relative"
                            title="Cette photo a été verrouillée par un organisateur">
                            {% if participant.custom_image %}
                            <img src="{{ url_for('static', filename=participant.custom_image.replace('/static/', '')) }}"
                                alt="Photo pour l'événement">
                            {% else %}
                            <div class="text-muted text-center p-2">
                                <i class="bi bi-lock-fill fs-1 text-danger"></i><br>
                                Photo verrouillée
                            </div>
                            {% endif %}
                            <span class="position-absolute top-0 end-0 badge bg-danger m-1">
                                <i class="bi bi-lock-fill"></i>
                            </span>
                        </div>
                        <div class="text-center mt-1">
                            <small class="text-danger fw-bold"><i class="bi bi-lock-fill"></i> Verrouillé par
                                l'org.</small>
                        </div>
                        {% else %}
                        <div class="photo-frame clickable" data-bs-toggle="modal"
                            data-bs-target="#uploadEventPhotoModal" title="Cliquer pour changer la photo">
                            {% if participant.custom_image %}
                            <img src="{{ url_for('static', filename=participant.custom_image.replace('/static/', '')) }}"
                                alt="Photo pour l'événement">
                            {% else %}
                            <div class="text-muted text-center p-2">
                                <i class="bi bi-camera fs-1"></i><br>
                                Ajouter une photo
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>


                {% if event.google_form_active and event.google_form_url %}
                <div class="mt-2 pt-2 border-top">
                    <i class="bi bi-file-text text-primary"></i>
                    <strong class="ms-1">Formulaire à remplir :</strong>
                    <a href="{{ event.google_form_url }}" target="_blank" class="ms-1">Accéder au formulaire Google
                        Forms</a>
                </div>
                {% endif %}
            </div>

            <!-- Modal Quitter l'événement -->
            <div class="modal fade" id="leaveEventModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Quitter l'événement
                                ?
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            {% if participant.is_organizer %}
                            {% set other_orgs_count = 0 %}
                            {% for p in event.participants if p.is_organizer and p.id != participant.id %}
                            {% set other_orgs_count = other_orgs_count + 1 %}
                            {% endfor %}

                            {% if other_orgs_count == 0 %}
                            <div class="alert alert-danger">
                                <strong>ATTENTION :</strong> Vous êtes le SEUL organisateur de cet événement.<br>
                                Si vous quittez, l'événement sera automatiquement passé en statut
                                <strong>"Annulé"</strong>
                                !
                            </div>
                            {% else %}
                            <p>Vous êtes organisateur. Votre départ n'annulera pas l'événement car il reste d'autres
                                organisateurs.</p>
                            {% endif %}
                            {% endif %}

                            <p>Êtes-vous sûr de vouloir retirer votre participation à <strong>{{ event.name }}</strong>
                                ?
                            </p>
                            <p class="text-muted small">Vous perdrez votre rôle assigné (le cas échéant) et votre statut
                                d'inscription.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <form action="{{ url_for('participant.leave', event_id=event.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-danger">Confirmer le départ</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}


            {% else %}
            {# Cas: Utilisateur ne participe pas encore #}
            {% if event.statut == 'Inscriptions ouvertes' %}
            <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#joinModal"
                data-mode="join">
                Rejoindre l'événement
            </button>
            {% elif event.statut in ['En préparation', 'Inscriptions fermées', 'Casting en cours',
            'Casting terminé', 'Rôles en cours de préparation', 'Rôles en cours d\'envois', 'Rôles envoyés, préparatifs
            de
            l\'événement'] %}
            <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal"
                data-bs-target="#joinModal" data-mode="interest">
                J'aimerais participer
            </button>
            {% else %}
            {# Statuts: Événement en cours, Terminé, Annulé, Reporté #}
            {% if event.statut == 'Annulé' %}
            <button class="btn btn-secondary" disabled>Événement annulé</button>
            {% elif event.statut == 'Terminé' %}
            <button class="btn btn-secondary" disabled>Événement clôturé</button>
            {% elif event.statut == 'Reporté' %}
            <button class="btn btn-secondary" disabled>Événement reporté</button>
            {% elif event.statut == 'Événement en cours' %}
            <button class="btn btn-success" disabled>Événement en cours</button>
            {% endif %}
            {% endif %}
            {% endif %}
        </div>
    </div>
</div><!-- Modals pour édition des coordonnées -->
{% if participant %}
<!-- Modal Facebook -->
<div class="modal fade" id="editFacebookModal" tabindex="-1" aria-labelledby="editFacebookLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFacebookLabel">
                    <i class="bi bi-facebook me-2"></i>Modifier mon Facebook
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form action="{{ url_for('participant.update_contact', event_id=event.id, participant_id=participant.id) }}"
                method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="field" value="facebook">
                <div class="modal-body">
                    <label for="facebook_value" class="form-label">URL de votre profil Facebook</label>
                    <input type="text" class="form-control" id="facebook_value" name="value"
                        value="{{ participant.participant_facebook or '' }}"
                        placeholder="https://facebook.com/votreprofile">
                    <div class="form-text">Laissez vide pour ne pas partager cette information</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Discord -->
<div class="modal fade" id="editDiscordModal" tabindex="-1" aria-labelledby="editDiscordLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDiscordLabel">
                    <i class="bi bi-discord me-2"></i>Modifier mon Discord
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form action="{{ url_for('participant.update_contact', event_id=event.id, participant_id=participant.id) }}"
                method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="field" value="discord">
                <div class="modal-body">
                    <label for="discord_value" class="form-label">Nom d'utilisateur Discord</label>
                    <input type="text" class="form-control" id="discord_value" name="value"
                        value="{{ participant.participant_discord or '' }}" placeholder="username#1234">
                    <div class="form-text">Laissez vide pour ne pas partager cette information</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Téléphone -->
<div class="modal fade" id="editPhoneModal" tabindex="-1" aria-labelledby="editPhoneLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPhoneLabel">
                    <i class="bi bi-smartphone me-2"></i>Modifier mon Téléphone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form action="{{ url_for('participant.update_contact', event_id=event.id, participant_id=participant.id) }}"
                method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="field" value="phone">
                <div class="modal-body">
                    <label for="phone_value" class="form-label">Numéro de téléphone</label>
                    <input type="tel" class="form-control" id="phone_value" name="value"
                        value="{{ participant.participant_phone or '' }}" placeholder="+33 6 12 34 56 78">
                    <div class="form-text">Laissez vide pour ne pas partager cette information</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal Upload Photo Événement -->
<div class="modal fade" id="uploadEventPhotoModal" tabindex="-1" aria-labelledby="uploadEventPhotoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadEventPhotoLabel">
                    <i class="bi bi-camera me-2"></i>Ma photo pour {{ event.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form
                action="{{ url_for('participant.update_event_photo', event_id=event.id, participant_id=participant.id) }}"
                method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p class="text-muted">
                        Ajoutez ou remplacez votre photo pour cet événement uniquement.
                        Cette photo sera utilisée pour le casting et les fiches personnages.
                    </p>
                    <div class="mb-3">
                        <label for="event_photo" class="form-label">Choisir une image</label>
                        <input class="form-control" type="file" id="event_photo" name="event_photo" accept="image/*"
                            required>
                        <div class="form-text">Formats acceptés : jpg, png, webp. Taille max : 5 Mo.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer la photo</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}