{# Organizer-only tabs content - extracted from event_detail.html #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/event_notifications.css') }}">

{# Description Tab (Organizer only) #}
<div class="tab-pane fade" id="list-general" role="tabpanel">
    <div class="card">
        <div class="card-header">Modifier les généralités</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('event.update_general', event_id=event.id) }}"
                enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="section-frame p-3 mb-4 rounded bg-body-tertiary border shadow-sm mx-1">
                    <h5 class="mb-3">Informations Principales</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom de l'événement</label>
                            <input type="text" class="form-control" name="name" value="{{ event.name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Association organisatrice</label>
                            <input type="text" class="form-control" name="organizing_association"
                                value="{{ event.organizing_association or 'une entité mystérieuse et inquiétante' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lieu</label>
                            <input type="text" class="form-control" name="location" value="{{ event.location }}"
                                required>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="display_organizers"
                                    id="display_organizers" {{ 'checked' if event.display_organizers else '' }}>
                                <label class="form-check-label" for="display_organizers">
                                    Afficher les organisateurs ?
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date de début</label>
                            <input type="date" class="form-control" name="date_start"
                                value="{{ event.date_start.strftime('%Y-%m-%d') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date de fin</label>
                            <input type="date" class="form-control" name="date_end"
                                value="{{ event.date_end.strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3">{{ event.description }}</textarea>
                    </div>
                </div>


                <div class="section-frame p-3 mb-4 rounded bg-body-secondary border shadow-sm mx-1">
                    <h5 class="mb-3">Images de fond</h5>
                    <div class="mb-3">
                        <label class="form-label">Thème Clair</label>
                        <input type="file" class="form-control" name="background_image_light"
                            accept=".jpg,.jpeg,.png,.webp">
                        <div class="form-text">Formats: JPG, PNG, WEBP.</div>
                        {% if event.background_image_light %}
                        <div class="mt-2">
                            <small>Image actuelle : <a
                                    href="{{ url_for('static', filename=event.background_image_light) }}"
                                    target="_blank">Voir</a></small>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Thème Sombre</label>
                        <input type="file" class="form-control" name="background_image_dark"
                            accept=".jpg,.jpeg,.png,.webp">
                        <div class="form-text">Formats: JPG, PNG, WEBP.</div>
                        {% if event.background_image_dark %}
                        <div class="mt-2">
                            <small>Image actuelle : <a
                                    href="{{ url_for('static', filename=event.background_image_dark) }}"
                                    target="_blank">Voir</a></small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="section-frame p-3 mb-4 rounded bg-body-tertiary border shadow-sm mx-1">
                    <h5 class="mb-3">Statut & Jauges</h5>
                    <div class="mb-3">
                        <label class="form-label">Statut de l'événement</label>
                        <select class="form-select" name="statut">
                            <option value="En préparation" {% if event.statut=='En préparation' %}selected{% endif %}>
                                En préparation</option>
                            <option value="Inscriptions ouvertes" {% if event.statut=='Inscriptions ouvertes'
                                %}selected{% endif %}>
                                Inscriptions ouvertes</option>
                            <option value="Inscriptions fermées" {% if event.statut=='Inscriptions fermées' %}selected{%
                                endif %}>
                                Inscriptions fermées</option>
                            <option value="Casting en cours" {% if event.statut=='Casting en cours' %}selected{% endif
                                %}>
                                Casting en cours</option>
                            <option value="Casting terminé" {% if event.statut=='Casting terminé' %}selected{% endif %}>
                                Casting terminé</option>
                            <option value="Rôles en cours de préparation" {% if
                                event.statut=='Rôles en cours de préparation' %}selected{% endif %}>Rôles en cours de
                                préparation</option>
                            <option value="Rôles en cours d'envois" {% if event.statut=="Rôles en cours d'envois"
                                %}selected{% endif %}>Rôles en cours d'envois</option>
                            <option value="Rôles envoyés, préparatifs de l'événement" {% if
                                event.statut=="Rôles envoyés, préparatifs de l'événement" %}selected{% endif %}>Rôles
                                envoyés, préparatifs de l'événement</option>
                            <option value="Événement en cours" {% if event.statut=='Événement en cours' %}selected{%
                                endif %}>
                                Événement en cours</option>
                            <option value="Terminé" {% if event.statut=='Terminé' %}selected{% endif %}>Terminé
                            </option>
                            <option value="Annulé" {% if event.statut=='Annulé' %}selected{% endif %}>Annulé
                            </option>
                            <option value="Reporté" {% if event.statut=='Reporté' %}selected{% endif %}>Reporté
                            </option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-warning-emphasis">Organisateurs</label>
                            <div class="d-flex align-items-center">
                                {% set limit = event.max_organizers if event.max_organizers is not none else 5 %}
                                {% set org_color = 'green' if count_orgs == limit else ('#FF8C00' if count_orgs < limit
                                    else 'red' ) %} <span class="fw-bold me-2"
                                    style="white-space: nowrap; color: {{ org_color }}">
                                    {{ count_orgs }} /
                                    </span>
                                    <input type="number" class="form-control form-control-sm" name="max_organizers"
                                        value="{{ limit }}" min="0">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-success-emphasis">PJ</label>
                            <div class="d-flex align-items-center">
                                {% set limit = event.max_pjs if event.max_pjs is not none else 50 %}
                                {% set pj_color = 'green' if count_pjs == limit else ('#FF8C00' if count_pjs < limit
                                    else 'red' ) %} <span class="fw-bold me-2"
                                    style="white-space: nowrap; color: {{ pj_color }}">
                                    {{ count_pjs }} /
                                    </span>
                                    <input type="number" class="form-control form-control-sm" name="max_pjs"
                                        value="{{ limit }}" min="0">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-info-emphasis">PNJ</label>
                            <div class="d-flex align-items-center">
                                {% set limit = event.max_pnjs if event.max_pnjs is not none else 10 %}
                                {% set pnj_color = 'green' if count_pnjs == limit else ('#FF8C00' if count_pnjs < limit
                                    else 'red' ) %} <span class="fw-bold me-2"
                                    style="white-space: nowrap; color: {{ pnj_color }}">
                                    {{ count_pnjs }} /
                                    </span>
                                    <input type="number" class="form-control form-control-sm" name="max_pnjs"
                                        value="{{ limit }}" min="0">
                            </div>
                        </div>
                    </div>
                </div>


                <div class="section-frame p-3 mb-4 rounded bg-body-tertiary border shadow-sm mx-1">
                    <h5 class="mb-2">Liens Externes</h5>
                    <div id="links-container">
                        {% for link in event.links_sorted %}
                        <div class="row mb-2 link-row">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" name="link_urls[]"
                                    placeholder="URL (https://...)" value="{{ link.url }}" required>
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" name="link_titles[]"
                                    placeholder="Titre (ex: Site Web)" value="{{ link.title }}" required>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-link-btn"><i
                                        class="bi bi-trash"></i></button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mb-0 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="add-link-btn"><i
                                class="bi bi-plus"></i>
                            Ajouter un lien</button>
                    </div>
                </div>
                <div class="section-frame p-3 mb-4 rounded bg-body-secondary border shadow-sm mx-1">
                    <h5 class="mb-2">Configuration P.A.F.</h5>
                    <div id="paf-config-container">
                        {% for paf in paf_config %}
                        <div class="row mb-2 paf-row">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" name="paf_names[]"
                                    placeholder="Nom (ex: PJ Standard)" value="{{ paf.name }}" required>
                            </div>
                            <div class="col-md-5">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" name="paf_amounts[]" placeholder="Montant"
                                        value="{{ paf.amount }}" step="0.01" required>
                                    <span class="input-group-text">€</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-paf-btn"><i
                                        class="bi bi-trash"></i></button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mb-0 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="add-paf-btn"><i
                                class="bi bi-plus"></i> Ajouter un tarif</button>
                    </div>
                </div>

                <div class="section-frame p-3 mb-4 rounded bg-body-secondary border shadow-sm mx-1">
                    <h5 class="mb-3">Moyens de Paiement Autorisés</h5>
                    <div class="mb-0">
                        <label class="form-label">Liste des moyens de paiement (séparés par des virgules)</label>
                        {% set current_methods = event.payment_methods|from_json if event.payment_methods else
                        ['Helloasso'] %}
                        <input type="text" class="form-control" name="payment_methods"
                            value="{{ current_methods|join(', ') }}" placeholder="Helloasso, PayPal, Espèces, Virement">
                        <div class="form-text">Ces options apparaîtront dans le menu déroulant "Moyen" de la gestion
                            PAF.</div>
                    </div>
                </div>

                <div class="section-frame p-3 mb-4 rounded bg-body-tertiary border shadow-sm mx-1">
                    <h5 class="mb-3">Formulaire Google & Webhook</h5>
                    <div class="mb-3">
                        <div class="alert alert-secondary p-2 d-flex align-items-center justify-content-between">
                            <div>
                                <strong>API_SECRET : </strong>
                                <span class="d-inline-flex align-items-center">
                                    <code class="user-select-all me-2"
                                        id="webhook-secret-value">{{ event.webhook_secret or 'Non généré' }}</code>
                                    <button type="button" class="btn btn-sm btn-outline-secondary p-1 lh-1"
                                        id="copy-secret-btn" title="Copier la clé" data-bs-toggle="tooltip">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </span>
                                <div class="mt-1">
                                    <a href="{{ url_for('static', filename='GOOGLE_APPS_SCRIPT.js') }}" target="_blank"
                                        class="small">
                                        <i class="bi bi-file-earmark-code"></i> code à mettre dans GFORMS
                                    </a>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="regenerate-secret-btn"
                                title="Régénérer la clé">
                                <i class="bi bi-arrow-clockwise"></i> Régénérer
                            </button>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label">URL Google Form</label>
                        <input type="text" class="form-control" name="google_form_url"
                            value="{{ event.google_form_url or '' }}">
                    </div>
                </div>

                <div class="section-frame p-3 mb-4 rounded bg-body-secondary border shadow-sm mx-1">
                    <h5 class="mb-3">Notifications Discord</h5>
                    <div class="mb-0">
                        <label class="form-label">URL Webhook Discord</label>
                        <input type="text" class="form-control" name="discord_webhook_url"
                            value="{{ event.discord_webhook_url or '' }}"
                            placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">Laissez vide pour désactiver les notifications Discord.</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </form>
        </div>
    </div>
</div>

{# Groups Configuration Tab (Organizer only) #}
<div class="tab-pane fade" id="list-groups" role="tabpanel">
    <div class="card">
        <div class="card-header">Configuration des groupes</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('event.update_groups', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <p class="text-muted">Séparez les groupes par des virgules. Exemple : Groupe A, Groupe B, Groupe C
                </p>
                <div class="mb-3">
                    <label class="form-label">Groupes PJ</label>
                    <input type="text" class="form-control" name="groups_pj"
                        value="{{ groups_config.get('PJ', [])|join(', ') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Groupes PNJ</label>
                    <input type="text" class="form-control" name="groups_pnj"
                        value="{{ groups_config.get('PNJ', [])|join(', ') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Groupes Organisateurs</label>
                    <input type="text" class="form-control" name="groups_org"
                        value="{{ groups_config.get('Organisateur', [])|join(', ') }}">
                </div>

                <button type="submit" class="btn btn-primary">Enregistrer la configuration</button>
            </form>
        </div>
    </div>
</div>

{# Roles Tab (Organizer only) #}
<div class="tab-pane fade" id="list-roles" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Gestion des Rôles <!-- TEST_MARKER_20260204_V2 --></span>
            <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addRoleModal">
                <i class="bi bi-plus"></i> Ajouter un rôle
            </button>
        </div>
        <div class="card-body">
            {# Toolbar: Filters for Roles #}
            <div class="row g-2 mb-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small mb-1 text-muted">Type</label>
                    <select class="form-select form-select-sm" id="role-filter-type">
                        <option value="">Peu importe</option>
                        <option value="Organisateur">Organisateur</option>
                        <option value="PJ">PJ</option>
                        <option value="PNJ">PNJ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1 text-muted">Groupe</label>
                    <select class="form-select form-select-sm" id="role-filter-group">
                        <option value="">Peu importe</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small mb-1 text-muted">Genre</label>
                    <select class="form-select form-select-sm" id="role-filter-genre">
                        <option value="">Tous</option>
                        <option value="Homme">H</option>
                        <option value="Femme">F</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
            </div>

            {# Roles Table #}
            {% if roles and roles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover small" id="role-management-table">
                    <thead class="table-dark">
                        <tr>
                            <th style="min-width: 200px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Nom</span>
                                    <button class="btn btn-sm btn-link p-0 text-light role-sort-btn" data-sort="name">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Type</span>
                                    <button class="btn btn-sm btn-link p-0 text-light role-sort-btn" data-sort="type">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Genre</span>
                                    <button class="btn btn-sm btn-link p-0 text-light role-sort-btn" data-sort="genre">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Groupe</span>
                                    <button class="btn btn-sm btn-link p-0 text-light role-sort-btn" data-sort="group">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th class="align-middle">GDoc</th>
                            <th class="align-middle">PDF</th>
                            <th class="text-center align-middle">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr data-type="{{ role.type }}" data-group="{{ role.group or '' }}"
                            data-genre="{{ role.genre or '' }}">
                            <td>
                                {% if role.comment %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ role.comment }}">
                                    {{ role.name }} <i class="bi bi-info-circle text-muted small"></i>
                                </span>
                                {% else %}
                                {{ role.name }}
                                {% endif %}
                            </td>
                            <td>
                                {% if role.type == 'Organisateur' %}
                                <span class="badge bg-warning text-dark">{{ role.type }}</span>
                                {% elif role.type == 'PJ' %}
                                <span class="badge bg-success">{{ role.type }}</span>
                                {% elif role.type == 'PNJ' %}
                                <span class="badge bg-info">{{ role.type }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ role.genre or '-' }}</td>
                            <td>{{ role.group or '-' }}</td>
                            <td>
                                {% if role.google_doc_url %}
                                <a href="{{ role.google_doc_url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-text"></i> gdoc
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if role.pdf_url %}
                                <a href="{{ role.pdf_url }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-file-pdf"></i> pdf
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-secondary me-1"
                                    data-bs-toggle="modal" data-bs-target="#editRoleModal{{ role.id }}"
                                    title="Modifier ce rôle">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteRoleModal{{ role.id }}" title="Supprimer ce rôle">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-person-badge" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucun rôle défini pour cet événement.</p>
                <p class="small">Cliquez sur "Ajouter un rôle" pour commencer.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Casting Tab (Organizer only) #}
<div class="tab-pane fade" id="casting-container" role="tabpanel" data-event-id="{{ event.id }}"
    data-csrf-token="{{ csrf_token() }}">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <span>Gestion de l'attribution des rôles</span>
                {# Validation Switch #}
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="castingValidationSwitch" {% if
                            event.is_casting_validated %}checked{% endif %}>
                        <label class="form-check-label" for="castingValidationSwitch" id="castingValidationLabel">
                            {% if event.is_casting_validated %}
                            <span class="badge bg-success">Validé</span>
                            {% else %}
                            <span class="badge bg-secondary">Non-validé</span>
                            {% endif %}
                        </label>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <div class="input-group input-group-sm" style="max-width: 300px;">
                    <input type="text" class="form-control" id="new-proposal-name"
                        placeholder="Nom de la proposition...">
                    <button class="btn btn-primary" type="button" id="add-proposal-btn">
                        <i class="bi bi-plus"></i> Ajouter une proposition
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if roles and roles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="casting-table">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">Rôle</th>
                            <th style="min-width: 80px;">Type</th>
                            <th style="min-width: 200px;" class="proposal-column" data-proposal-id="main">Attribution
                            </th>
                            {# Dynamic proposal columns will be added here by JavaScript #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr data-role-id="{{ role.id }}" data-role-type="{{ role.type }}">
                            <td>
                                {% if role.comment %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ role.comment }}">
                                    {{ role.name }} <i class="bi bi-info-circle text-muted small"></i>
                                </span>
                                {% else %}
                                {{ role.name }}
                                {% endif %}
                            </td>
                            <td>
                                {% if role.type == 'Organisateur' %}
                                <span class="badge bg-warning text-dark">{{ role.type }}</span>
                                {% elif role.type == 'PJ' %}
                                <span class="badge bg-success">{{ role.type }}</span>
                                {% elif role.type == 'PNJ' %}
                                <span class="badge bg-info">{{ role.type }}</span>
                                {% else %}
                                <span class="badge bg-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="assignment-cell" data-proposal-id="main">
                                <select class="form-select form-select-sm casting-select" data-role-id="{{ role.id }}"
                                    data-proposal-id="main" data-role-type="{{ role.type }}">
                                    <option value="">-- Non attribué --</option>
                                </select>
                            </td>
                            {# Dynamic proposal cells will be added here by JavaScript #}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-person-video2" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucun rôle défini pour cet événement.</p>
                <p class="small">Créez d'abord des rôles dans l'onglet "Rôles" pour utiliser le casting.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>







{# Groups configuration data - passed as JSON for external JavaScript #}
<script type="application/json" id="groups-config-data">{{ groups_config | tojson }}</script>

{# Event Organizer JavaScript - Loaded from external file #}
<script src="{{ url_for('static', filename='js/event_organizer.js') }}"></script>
{# Casting JavaScript - Loaded from external file #}
<script src="{{ url_for('static', filename='js/casting.js') }}"></script>
{# Tabs Logic JavaScript - Refactored #}
{# Context Data for JS #}
<div id="event-context-data" data-event-id="{{ event.id }}" data-csrf-token="{{ csrf_token() }}"
    data-base-url="{{ config.APPLICATION_ROOT or '' }}"
    data-regenerate-url="{{ url_for('event.regenerate_secret', event_id=event.id) }}" style="display: none;"></div>

<script>
    // Robust initialization of global context
    window.GN_CONTEXT = {
        eventId: "{{ event.id }}",
        csrfToken: "{{ csrf_token() }}",
        baseUrl: "{{ config.APPLICATION_ROOT or '' }}",
        regenerateUrl: "{{ url_for('event.regenerate_secret', event_id=event.id) }}"
    };
</script>
<script src="{{ url_for('static', filename='js/event_organizer_tabs.js') }}?v=fixed_v2"></script>
{% include "partials/casting_templates.html" %}

{# P.A.F. Management Tab Content #}
<div class="tab-pane fade" id="list-paf" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold fs-5">Gestion de la P.A.F.</span>
                <select class="form-select form-select-sm w-auto shadow-none border-secondary" id="pafTypeFilter">
                    <option value="all">Tous les types</option>
                    <option value="PJ">PJ</option>
                    <option value="PNJ">PNJ</option>
                    <option value="Organisateur">Organisateur</option>
                </select>
                <select class="form-select form-select-sm w-auto shadow-none border-secondary" id="pafStatusFilter">
                    <option value="all">Tous les états</option>
                    <option value="versée">Versée</option>
                    <option value="partielle">Partielle</option>
                    <option value="non versée">Non versée</option>
                    <option value="dispensé(e)">Dispensé(e)</option>
                    <option value="erreur">Erreur</option>
                </select>
            </div>
            <div class="d-flex gap-2 flex-wrap justify-content-end">
                <span class="badge bg-primary d-flex align-items-center" title="Nombre de participants affichés">
                    <i class="bi bi-people me-1"></i>
                    <span id="pafCount" class="me-1">{{ event.participants|length }}</span>
                </span>
                <span class="badge bg-success d-flex align-items-center" title="Total effectivement versé">
                    <i class="bi bi-cash-coin me-1"></i>
                    Versé : <span id="pafTotalPaidDisplay">0.00 €</span>
                </span>
                <span class="badge bg-danger d-flex align-items-center"
                    title="Reste à percevoir (somme des dus positifs)">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    Manque : <span id="pafTotalMissingDisplay">0.00 €</span>
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle small" id="paf-management-table">
                    <thead class="table-dark">
                        <tr>
                            <th style="min-width: 200px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Participant</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn"
                                        data-sort="participant">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th class="align-middle">Contact</th>
                            <th style="min-width: 110px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>État</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn" data-sort="status">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th style="min-width: 110px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Versé</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn" data-sort="paid">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th style="min-width: 160px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Type PAF</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn" data-sort="type">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th style="min-width: 140px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Moyen</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn" data-sort="method">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th style="min-width: 110px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Dû</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn" data-sort="due">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                            <th style="min-width: 110px;" class="align-middle">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Reste</span>
                                    <button class="btn btn-sm btn-link p-0 text-light paf-sort-btn"
                                        data-sort="remaining">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in event.participants %}
                        {# Calculate remaining for data attribute #}
                        {% set p_due = paf_map.get(p.paf_type, 0) %}
                        {% set p_remaining = p_due - p.payment_amount %}
                        <tr class="paf-row paf-participant-row" data-paf-type="{{ p.type }}"
                            data-paf-status="{{ p.paf_status }}" data-paf-paid="{{ p.payment_amount }}"
                            data-paf-remaining="{{ p_remaining }}">
                            <td>
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="fw-bold me-2">{{ p.user.nom }} {{ p.user.prenom }}</div>
                                    <button type="button"
                                        class="btn btn-sm paf-global-comment-btn {{ 'btn-outline-danger' if p.global_comment else 'btn-outline-primary' }}"
                                        data-p-id="{{ p.id }}" data-p-name="{{ p.user.nom }} {{ p.user.prenom }}"
                                        data-comment="{{ p.global_comment or '' }}"
                                        title="{{ p.global_comment or 'Aucun commentaire général' }}">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                </div>
                                {% set type_color = 'text-warning' if p.type == 'Organisateur' else ('text-success' if
                                p.type == 'PJ' else 'text-primary') %}
                                <small class="{{ type_color }} fw-bold">({{ p.type }})</small>
                            </td>
                            <td>
                                {% set discord_val = p.participant_discord or p.user.discord %}
                                {% set facebook_val = p.participant_facebook or p.user.facebook %}
                                {% set phone_val = p.participant_phone or p.user.phone %}

                                {% set show_discord = discord_val if p.share_discord else None %}
                                {% set show_facebook = facebook_val if p.share_facebook else None %}
                                {% set show_phone = phone_val if p.share_phone else None %}

                                <!-- Grille 2x2 stricte -->
                                <div
                                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; width: fit-content; margin: 0 auto;">
                                    <div class="d-flex justify-content-center">
                                        <i class="bi bi-envelope cursor-pointer contact-icon fw-bold text-primary"
                                            title="{{ p.user.email }}" data-copy-text="{{ p.user.email }}"
                                            style="font-size: 1rem;"></i>
                                    </div>

                                    <div class="d-flex justify-content-center">
                                        <i class="bi bi-discord cursor-pointer contact-icon {{ 'text-primary' if show_discord else '' }}"
                                            title="{{ show_discord or 'Non renseigné ou privé' }}"
                                            data-copy-text="{{ show_discord or 'Non renseigné ou privé' }}"
                                            style="font-size: 1rem; opacity: {{ 1 if show_discord else 0.3 }};"></i>
                                    </div>

                                    <div class="d-flex justify-content-center">
                                        <i class="bi bi-facebook cursor-pointer contact-icon {{ 'text-primary' if show_facebook else '' }}"
                                            title="{{ show_facebook or 'Non renseigné ou privé' }}"
                                            data-copy-text="{{ show_facebook or 'Non renseigné ou privé' }}"
                                            style="font-size: 1rem; opacity: {{ 1 if show_facebook else 0.3 }};"></i>
                                    </div>

                                    <div class="d-flex justify-content-center">
                                        <i class="bi bi-telephone cursor-pointer contact-icon {{ 'text-success' if show_phone else '' }}"
                                            title="{{ show_phone or 'Non renseigné ou privé' }}"
                                            data-copy-text="{{ show_phone or 'Non renseigné ou privé' }}"
                                            style="font-size: 1rem; opacity: {{ 1 if show_phone else 0.3 }};"></i>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% set paf_color = 'danger' %}
                                {% if p.paf_status == 'versée' %}{% set paf_color = 'success' %}
                                {% elif p.paf_status == 'partielle' %}{% set paf_color = 'warning text-dark' %}
                                {% endif %}
                                <span class="badge bg-{{ paf_color }} paf-status-badge" data-p-id="{{ p.id }}">{{
                                    p.paf_status|capitalize }}</span>
                            </td>
                            <td>
                                <div class="input-group input-group-sm" style="min-width: 120px;">
                                    <input type="number"
                                        class="form-control paf-inline-edit-amount no-spinner fw-bold text-end"
                                        step="0.01" value="{{ '%.2f'|format(p.payment_amount) }}" data-p-id="{{ p.id }}"
                                        placeholder="0.00">
                                    <span class="input-group-text">€</span>
                                </div>
                            </td>
                            <td>
                                <select class="form-select form-select-sm paf-inline-edit" data-p-id="{{ p.id }}"
                                    data-field="paf_type">
                                    <option value="" {% if not p.paf_type %}selected{% endif %}>Selectionner...
                                    </option>
                                    {% for conf in paf_config %}
                                    <option value="{{ conf.name }}" {% if p.paf_type==conf.name %}selected{% endif %}>
                                        {{ conf.name }} ({{ conf.amount }} €)
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <div class="d-flex align-items-center justify-content-between">
                                    {% set payment_methods = event.payment_methods|from_json if event.payment_methods
                                    else ['Helloasso'] %}
                                    <select class="form-select form-select-sm paf-inline-edit me-1"
                                        data-p-id="{{ p.id }}" data-field="payment_method">
                                        <option value="">Choisir...</option>
                                        {% for method in payment_methods %}
                                        <option value="{{ method }}" {% if p.payment_method==method %}selected{% endif
                                            %}>{{ method }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button"
                                        class="btn btn-sm paf-info-btn {{ 'btn-outline-danger' if p.info_payement else 'btn-outline-primary' }}"
                                        data-p-id="{{ p.id }}" data-p-name="{{ p.user.nom }} {{ p.user.prenom }}"
                                        data-info="{{ p.info_payement or '' }}"
                                        title="{{ p.info_payement or 'Aucune information' }}">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                {% set due = paf_map.get(p.paf_type, 0) %}
                                <span class="fw-bold paf-due-amount" data-p-id="{{ p.id }}">{{ "%.2f"|format(due) }}
                                    €</span>
                            </td>
                            <td>
                                {% if not p.paf_type %}
                                <span class="text-muted fs-4">?</span>
                                {% else %}
                                {% set remaining = due - p.payment_amount %}
                                <div class="paf-remaining-container" data-p-id="{{ p.id }}">
                                    {% if remaining > 0.01 %}
                                    <span class="text-danger fw-bold">{{ "%.2f"|format(remaining) }} €</span>
                                    {% elif remaining < -0.01 %} <span class="text-success">{{ "%.2f"|format(remaining)
                                        }} €
                                        (Trop perçu)</span>
                                        {% else %}
                                        <span class="text-success"><i class="bi bi-check-lg"></i> Payé</span>
                                        {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Notifications Tab (Organizer only) #}
<div class="tab-pane fade" id="list-notifications" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bell"></i> Notifications</span>
            {% if notifications and notifications|length > 0 %}
            <button class="btn btn-sm btn-outline-secondary" id="mark-all-read-btn">
                Tout marquer comme lu
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if notifications and notifications|length > 0 %}
            <div class="list-group">
                {% for notif in notifications %}
                <div class="list-group-item {% if not notif.is_read %}notification-unread{% endif %}"
                    data-notif-id="{{ notif.id }}">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ notif.user.prenom }} {{ notif.user.nom }}</h6>
                            <p class="mb-1">{{ notif.description }}</p>
                            <small class="text-muted">{{ notif.created_at.strftime('%d/%m/%Y à %H:%M') }}</small>
                        </div>
                        {% if not notif.is_read %}
                        <button class="btn btn-sm btn-outline-primary ms-3 mark-read-btn"
                            data-notif-id="{{ notif.id }}">
                            <i class="bi bi-check"></i> Marquer comme lu
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucune notification pour cet événement.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# GForms Tab (Organizer only) #}
<div class="tab-pane fade" id="list-gforms" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Gestion Google Forms [V2]</span>
            <div>
                <input type="file" id="import-gforms-file" accept=".csv" style="display: none;">
                <button class="btn btn-sm btn-outline-primary me-1" id="import-gforms-btn"
                    title="Importer depuis un CSV">
                    <i class="bi bi-upload"></i> Importer
                </button>
                <button class="btn btn-sm btn-outline-success me-1" id="export-gforms-btn"
                    title="Exporter au format CSV">
                    <i class="bi bi-download"></i> Exporter
                </button>
                <button class="btn btn-sm btn-outline-primary refresh-gforms-btn" title="Actualiser">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if not event.webhook_secret %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Fonctionnalité désactivée</strong>
                <p class="mb-0">
                    Le menu GForms est désactivé car aucun "Secret Webhook" n'a été généré pour cet événement.<br>
                    Veuillez aller dans l'onglet <strong>Généralités</strong>, section "Intégration Google Forms", et
                    générer un secret.
                </p>
            </div>
            {% else %}
            <!-- GForms Sub-tabs -->
            <ul class="nav nav-tabs mb-3" id="gformsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="gforms-formulaires-tab" data-bs-toggle="tab"
                        data-bs-target="#gforms-formulaires" type="button" role="tab">
                        <i class="bi bi-table me-1"></i> Formulaires
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gforms-categories-tab" data-bs-toggle="tab"
                        data-bs-target="#gforms-categories" type="button" role="tab">
                        <i class="bi bi-tags me-1"></i> Catégories
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gforms-settings-tab" data-bs-toggle="tab"
                        data-bs-target="#gforms-settings" type="button" role="tab">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="gformsTabsContent">
                <!-- Tab 1: Formulaires -->
                <div class="tab-pane fade show active" id="gforms-formulaires" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead id="gforms-table-head">
                                <tr>
                                    <th>Email</th>
                                    <th>Timestamp</th>
                                    <th>Type d'ajout</th>
                                    <!-- Dynamic columns -->
                                </tr>
                            </thead>
                            <tbody id="gforms-table-body">
                                <tr>
                                    <td colspan="100%" class="text-center text-muted p-4">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="gforms-pagination" class="d-flex justify-content-between align-items-center mt-3">
                        <!-- Pagination controls -->
                    </div>
                </div>

                <!-- Tab 2: Catégories -->
                <div class="tab-pane fade" id="gforms-categories" role="tabpanel">
                    <div class="alert alert-info py-2">
                        <i class="bi bi-info-circle me-2"></i>
                        Définissez ici les catégories de champs et leurs couleurs associées.
                    </div>

                    <div id="categories-list" class="mb-3">
                        <!-- Categories loaded via JS -->
                    </div>

                    <button id="add-category-btn" class="btn btn-outline-secondary mb-3">
                        <i class="bi bi-plus-circle me-2"></i> Ajouter une catégorie
                    </button>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end border-top pt-3">
                        <button id="save-categories-btn" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i> Enregistrer les catégories
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Settings (Mappings) -->
                <div class="tab-pane fade" id="gforms-settings" role="tabpanel">
                    <div class="alert alert-info py-2">
                        <i class="bi bi-info-circle me-2"></i>
                        Associez chaque champ du formulaire à une catégorie pour la coloration.
                    </div>

                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40%;">Champ du formulaire</th>
                                    <th style="width: 30%;">Alias d'affichage</th>
                                    <th style="width: 30%;">Catégorie associée</th>
                                </tr>
                            </thead>
                            <tbody id="field-mappings-body">
                                <!-- Mappings loaded via JS -->
                            </tbody>
                        </table>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end border-top pt-3 mt-3">
                        <button id="save-mappings-btn" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i> Enregistrer les associations
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- GForms Resources -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/gforms.css') }}">
<script src="{{ url_for('static', filename='js/gforms.js', v='2.4') }}"></script>