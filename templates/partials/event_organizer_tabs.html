{# Organizer-only tabs content - extracted from event_detail.html #}

{# Description Tab (Organizer only) #}
<div class="tab-pane fade" id="list-general" role="tabpanel">
    <div class="card">
        <div class="card-header">Modifier les généralités</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('event.update_general', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="mb-3">
                    <label class="form-label">Titre de l'événement</label>
                    <input type="text" class="form-control" name="name" value="{{ event.name }}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Lieu</label>
                    <input type="text" class="form-control" name="location" value="{{ event.location }}">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date de début</label>
                        <input type="date" class="form-control" name="date_start"
                            value="{{ event.date_start.strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date de fin</label>
                        <input type="date" class="form-control" name="date_end"
                            value="{{ event.date_end.strftime('%Y-%m-%d') }}" required>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3">Statut de l'événement</h5>
                <div class="mb-3">
                    <select class="form-select" name="statut">
                        <option value="En préparation" {% if event.statut=='En préparation' %}selected{% endif %}>En
                            préparation</option>
                        <option value="Inscriptions ouvertes" {% if event.statut=='Inscriptions ouvertes' %}selected{%
                            endif %}>Inscriptions ouvertes</option>
                        <option value="Inscriptions fermées" {% if event.statut=='Inscriptions fermées' %}selected{%
                            endif %}>Inscriptions fermées</option>
                        <option value="Casting en cours" {% if event.statut=='Casting en cours' %}selected{% endif %}>
                            Casting en cours</option>
                        <option value="Casting terminé" {% if event.statut=='Casting terminé' %}selected{% endif %}>
                            Casting terminé</option>
                        <option value="Rôles en cours de préparation" {% if
                            event.statut=='Rôles en cours de préparation' %}selected{% endif %}>Rôles en cours de
                            préparation</option>
                        <option value="Rôles en cours d'envois" {% if event.statut=='Rôles en cours d\' envois'
                            %}selected{% endif %}>Rôles en cours d'envois</option>
                        <option value="Rôles envoyés, préparatifs de l'événement" {% if
                            event.statut=='Rôles envoyés, préparatifs de l\' événement' %}selected{% endif %}>Rôles
                            envoyés, préparatifs de l'événement</option>
                        <option value="Événement en cours" {% if event.statut=='Événement en cours' %}selected{% endif
                            %}>Événement en cours</option>
                        <option value="Terminé" {% if event.statut=='Terminé' %}selected{% endif %}>Terminé</option>
                        <option value="Annulé" {% if event.statut=='Annulé' %}selected{% endif %}>Annulé</option>
                        <option value="Reporté" {% if event.statut=='Reporté' %}selected{% endif %}>Reporté</option>
                    </select>
                </div>

                <hr>
                <h5 class="mb-3">Jauges (Participants Max)</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Organisateurs</label>
                        <div class="d-flex align-items-center">
                            {% set limit = event.max_organizers if event.max_organizers is not none else 5 %}
                            {% set org_color = 'green' if count_orgs == limit else ('#FF8C00' if count_orgs < limit
                                else 'red' ) %} <span class="fw-bold me-2"
                                style="white-space: nowrap; color: {{ org_color }}">
                                {{ count_orgs }} inscrits sur
                                </span>
                                <input type="number" class="form-control" name="max_organizers" value="{{ limit }}"
                                    min="0">
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">PJ</label>
                        <div class="d-flex align-items-center">
                            {% set limit = event.max_pjs if event.max_pjs is not none else 50 %}
                            {% set pj_color = 'green' if count_pjs == limit else ('#FF8C00' if count_pjs < limit
                                else 'red' ) %} <span class="fw-bold me-2"
                                style="white-space: nowrap; color: {{ pj_color }}">
                                {{ count_pjs }} inscrits sur
                                </span>
                                <input type="number" class="form-control" name="max_pjs" value="{{ limit }}" min="0">
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">PNJ</label>
                        <div class="d-flex align-items-center">
                            {% set limit = event.max_pnjs if event.max_pnjs is not none else 10 %}
                            {% set pnj_color = 'green' if count_pnjs == limit else ('#FF8C00' if count_pnjs < limit
                                else 'red' ) %} <span class="fw-bold me-2"
                                style="white-space: nowrap; color: {{ pnj_color }}">
                                {{ count_pnjs }} inscrits sur
                                </span>
                                <input type="number" class="form-control" name="max_pnjs" value="{{ limit }}" min="0">
                        </div>
                    </div>
                </div>
                <hr>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3">{{ event.description }}</textarea>
                </div>
                <hr>
                <h6>Liens Externes</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Lien externe (URL)</label>
                        <input type="text" class="form-control" name="org_link_url"
                            value="{{ event.org_link_url or '' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Titre du lien</label>
                        <input type="text" class="form-control" name="org_link_title"
                            value="{{ event.org_link_title or '' }}">
                    </div>
                </div>
                <hr>
                <h6>Formulaire Google</h6>
                <div class="mb-3">
                    <label class="form-label">URL Google Form</label>
                    <input type="text" class="form-control" name="google_form_url"
                        value="{{ event.google_form_url or '' }}">
                </div>
                <hr>
                <h6>Notifications Discord</h6>
                <div class="mb-3">
                    <label class="form-label">URL Webhook Discord</label>
                    <input type="text" class="form-control" name="discord_webhook_url"
                        value="{{ event.discord_webhook_url or '' }}"
                        placeholder="https://discord.com/api/webhooks/...">
                    <div class="form-text">Laissez vide pour désactiver les notifications Discord.</div>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </form>
        </div>
    </div>
</div>

{# Groups Configuration Tab (Organizer only) #}
<div class="tab-pane fade" id="list-groups" role="tabpanel">
    <div class="card">
        <div class="card-header">Configuration des groupes</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('event.update_groups', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <p class="text-muted">Séparez les groupes par des virgules. Exemple : Groupe A, Groupe B, Groupe C
                </p>
                <div class="mb-3">
                    <label class="form-label">Groupes PJ</label>
                    <input type="text" class="form-control" name="groups_pj"
                        value="{{ groups_config.get('PJ', [])|join(', ') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Groupes PNJ</label>
                    <input type="text" class="form-control" name="groups_pnj"
                        value="{{ groups_config.get('PNJ', [])|join(', ') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Groupes Organisateurs</label>
                    <input type="text" class="form-control" name="groups_org"
                        value="{{ groups_config.get('Organisateur', [])|join(', ') }}">
                </div>

                <button type="submit" class="btn btn-primary">Enregistrer la configuration</button>
            </form>
        </div>
    </div>
</div>

{# Roles Tab (Organizer only) #}
<div class="tab-pane fade" id="list-roles" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Gestion des Rôles</span>
            <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addRoleModal">
                <i class="bi bi-plus"></i> Ajouter un rôle
            </button>
        </div>
        <div class="card-body">
            {# Roles Table #}
            {% if roles and roles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Genre</th>
                            <th>Groupe</th>
                            <th>GDoc</th>
                            <th>PDF</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr>
                            <td>
                                {% if role.comment %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ role.comment }}">
                                    {{ role.name }} <i class="bi bi-info-circle text-muted small"></i>
                                </span>
                                {% else %}
                                {{ role.name }}
                                {% endif %}
                            </td>
                            <td>
                                {% if role.type == 'Organisateur' %}
                                <span class="badge bg-warning text-dark">{{ role.type }}</span>
                                {% elif role.type == 'PJ' %}
                                <span class="badge bg-success">{{ role.type }}</span>
                                {% elif role.type == 'PNJ' %}
                                <span class="badge bg-info">{{ role.type }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ role.genre or '-' }}</td>
                            <td>{{ role.group or '-' }}</td>
                            <td>
                                {% if role.google_doc_url %}
                                <a href="{{ role.google_doc_url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-text"></i> gdoc
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if role.pdf_url %}
                                <a href="{{ role.pdf_url }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-file-pdf"></i> pdf
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#editRoleModal{{ role.id }}" title="Modifier ce rôle">
                                    <i class="bi bi-gear"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-person-badge" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucun rôle défini pour cet événement.</p>
                <p class="small">Cliquez sur "Ajouter un rôle" pour commencer.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Casting Tab (Organizer only) #}
<div class="tab-pane fade" id="list-casting" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <span><i class="bi bi-person-video2"></i> Casting</span>
                {# Validation Switch #}
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="castingValidationSwitch" {% if
                            event.is_casting_validated %}checked{% endif %}>
                        <label class="form-check-label" for="castingValidationSwitch" id="castingValidationLabel">
                            {% if event.is_casting_validated %}
                            <span class="badge bg-success">Validé</span>
                            {% else %}
                            <span class="badge bg-secondary">Non-validé</span>
                            {% endif %}
                        </label>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <div class="input-group input-group-sm" style="max-width: 300px;">
                    <input type="text" class="form-control" id="new-proposal-name"
                        placeholder="Nom de la proposition...">
                    <button class="btn btn-primary" type="button" id="add-proposal-btn">
                        <i class="bi bi-plus"></i> Ajouter une proposition
                    </button>
                </div>
                {% if not event.is_casting_validated %}
                <button class="btn btn-success btn-sm" type="button" id="auto-assign-btn"
                    title="Calculer les attributions en fonction des scores">
                    <i class="bi bi-calculator"></i> Calculer les attributions
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            {% if roles and roles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="casting-table">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">Rôle</th>
                            <th style="min-width: 80px;">Type</th>
                            <th style="min-width: 200px;" class="proposal-column" data-proposal-id="main">Attribution
                            </th>
                            {# Dynamic proposal columns will be added here by JavaScript #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr data-role-id="{{ role.id }}" data-role-type="{{ role.type }}">
                            <td>
                                {% if role.comment %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ role.comment }}">
                                    {{ role.name }} <i class="bi bi-info-circle text-muted small"></i>
                                </span>
                                {% else %}
                                {{ role.name }}
                                {% endif %}
                            </td>
                            <td>
                                {% if role.type == 'Organisateur' %}
                                <span class="badge bg-warning text-dark">{{ role.type }}</span>
                                {% elif role.type == 'PJ' %}
                                <span class="badge bg-success">{{ role.type }}</span>
                                {% elif role.type == 'PNJ' %}
                                <span class="badge bg-info">{{ role.type }}</span>
                                {% else %}
                                <span class="badge bg-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="assignment-cell" data-proposal-id="main">
                                <select class="form-select form-select-sm casting-select" data-role-id="{{ role.id }}"
                                    data-proposal-id="main" data-role-type="{{ role.type }}">
                                    <option value="">-- Non attribué --</option>
                                </select>
                            </td>
                            {# Dynamic proposal cells will be added here by JavaScript #}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-person-video2" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucun rôle défini pour cet événement.</p>
                <p class="small">Créez d'abord des rôles dans l'onglet "Rôles" pour utiliser le casting.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Casting JavaScript #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const eventId = {{ event.id }
    };
    const csrfToken = '{{ csrf_token() }}';


    // Participants data grouped by type
    let participantsByType = {};
    let proposals = [];
    let assignments = {};
    let scores = {};

    // Load casting data on tab show
    const castingTab = document.getElementById('list-casting-list');
    if (castingTab) {
        castingTab.addEventListener('shown.bs.tab', loadCastingData);
        // Also load if already active
        if (castingTab.classList.contains('active')) {
            loadCastingData();
        }
    }

    async function loadCastingData() {
        try {
            const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting_data`);
            const data = await response.json();

            participantsByType = data.participants_by_type;
            proposals = data.proposals;
            assignments = data.assignments;
            scores = data.scores || {};

            // Build proposal columns
            rebuildProposalColumns();

            // Populate all dropdowns
            populateAllDropdowns();

        } catch (error) {
            console.error('Error loading casting data:', error);
        }
    }

    function rebuildProposalColumns() {
        const headerRow = document.querySelector('#casting-table thead tr');
        const bodyRows = document.querySelectorAll('#casting-table tbody tr');

        // Remove existing dynamic proposal columns (keep first 3: Rôle, Type, Attribution)
        headerRow.querySelectorAll('th.dynamic-proposal').forEach(th => th.remove());
        bodyRows.forEach(row => {
            row.querySelectorAll('td.dynamic-proposal').forEach(td => td.remove());
        });

        // Add proposal columns
        proposals.forEach(proposal => {
            // Header
            const th = document.createElement('th');
            th.style.minWidth = '200px';
            th.className = 'proposal-column dynamic-proposal';
            th.dataset.proposalId = proposal.id;
            th.innerHTML = `
                ${proposal.name}
                <button class="btn btn-sm btn-outline-danger ms-2 delete-proposal-btn" 
                        data-proposal-id="${proposal.id}" title="Supprimer cette proposition">
                    <i class="bi bi-x"></i>
                </button>
            `;
            headerRow.appendChild(th);

            // Body cells
            bodyRows.forEach(row => {
                const roleId = row.dataset.roleId;
                const roleType = row.dataset.roleType;
                const td = document.createElement('td');
                td.className = 'assignment-cell dynamic-proposal';
                td.dataset.proposalId = proposal.id;
                td.innerHTML = `
                    <div class="d-flex gap-2 align-items-center">
                        <select class="form-select form-select-sm casting-select flex-grow-1" 
                                data-role-id="${roleId}" 
                                data-proposal-id="${proposal.id}"
                                data-role-type="${roleType}">
                            <option value="">-- Non attribué --</option>
                        </select>
                        <select class="form-select form-select-sm score-select" 
                                style="width: 70px;"
                                data-role-id="${roleId}" 
                                data-proposal-id="${proposal.id}"
                                title="Score (0-10)">
                            ${[...Array(11).keys()].map(i => `<option value="${i}">${i}</option>`).join('')}
                        </select>
                    </div>
                `;
                row.appendChild(td);
            });
        });

        // Add event listeners to new delete buttons
        document.querySelectorAll('.delete-proposal-btn').forEach(btn => {
            btn.addEventListener('click', deleteProposal);
        });
    }

    function populateAllDropdowns() {
        document.querySelectorAll('.casting-select').forEach(select => {
            const roleId = select.dataset.roleId;
            const proposalId = select.dataset.proposalId;

            // Get already assigned participant IDs for this proposal (excluding current role)
            const assignedIds = getAssignedParticipantIds(proposalId, roleId);

            // Clear and repopulate with ALL participants grouped by type
            select.innerHTML = '<option value="">-- Non attribué --</option>';

            // Add all participants grouped by their type
            for (const [type, participants] of Object.entries(participantsByType)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = type;

                participants.forEach(p => {
                    // Skip if already assigned to another role in this proposal
                    if (assignedIds.includes(p.id)) return;

                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nom} ${p.prenom}`;
                    optgroup.appendChild(option);
                });

                // Only add optgroup if it has options
                if (optgroup.childElementCount > 0) {
                    select.appendChild(optgroup);
                }
            }

            // Set current value if assigned
            const currentAssignment = getAssignment(proposalId, roleId);
            if (currentAssignment) {
                select.value = currentAssignment;
            }
        });

        // Add change event listeners
        document.querySelectorAll('.casting-select').forEach(select => {
            select.removeEventListener('change', handleAssignmentChange);
            select.addEventListener('change', handleAssignmentChange);
        });

        // Populate and add change event listeners for scores
        document.querySelectorAll('.score-select').forEach(scoreSelect => {
            const roleId = scoreSelect.dataset.roleId;
            const proposalId = scoreSelect.dataset.proposalId;

            // Skip 'main' proposal as it doesn't have scores
            if (proposalId === 'main') {
                return;
            }

            // Get current score (default to 0, handling 0 as valid value)
            let currentScore = 0;
            if (scores[proposalId] && scores[proposalId][roleId] !== undefined) {
                currentScore = scores[proposalId][roleId];
            }
            scoreSelect.value = currentScore;

            // Add event listener for score changes
            scoreSelect.removeEventListener('change', handleScoreChange);
            scoreSelect.addEventListener('change', handleScoreChange);
        });
    }

    function getAssignedParticipantIds(proposalId, excludeRoleId) {
        const assigned = [];
        const proposalAssignments = assignments[proposalId] || {};
        for (const [roleId, participantId] of Object.entries(proposalAssignments)) {
            if (roleId !== excludeRoleId && participantId) {
                assigned.push(parseInt(participantId));
            }
        }
        return assigned;
    }

    function getAssignment(proposalId, roleId) {
        return assignments[proposalId]?.[roleId] || null;
    }

    async function handleAssignmentChange(event) {
        const select = event.target;
        const roleId = select.dataset.roleId;
        const proposalId = select.dataset.proposalId;
        const participantId = select.value || null;

        try {
            const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    role_id: roleId,
                    proposal_id: proposalId,
                    participant_id: participantId
                })
            });

            if (response.ok) {
                // Update local assignments
                if (!assignments[proposalId]) {
                    assignments[proposalId] = {};
                }
                assignments[proposalId][roleId] = participantId;

                // Refresh all dropdowns for this proposal to update available options
                populateAllDropdowns();
            } else {
                console.error('Failed to save assignment');
                // Revert the change
                loadCastingData();
            }
        } catch (error) {
            console.error('Error saving assignment:', error);
            loadCastingData();
        }
    }

    async function handleScoreChange(event) {
        const scoreSelect = event.target;
        const roleId = scoreSelect.dataset.roleId;
        const proposalId = scoreSelect.dataset.proposalId;
        const score = parseInt(scoreSelect.value);

        try {
            const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting/update_score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    role_id: roleId,
                    proposal_id: proposalId,
                    score: score
                })
            });

            if (response.ok) {
                // Update local scores
                if (!scores[proposalId]) {
                    scores[proposalId] = {};
                }
                scores[proposalId][roleId] = score;
            } else {
                console.error('Failed to save score');
                // Revert the change
                loadCastingData();
            }
        } catch (error) {
            console.error('Error saving score:', error);
            loadCastingData();
        }
    }

    // Add proposal button
    const addProposalBtn = document.getElementById('add-proposal-btn');
    if (addProposalBtn) {
        addProposalBtn.addEventListener('click', async function () {
            const nameInput = document.getElementById('new-proposal-name');
            const name = nameInput.value.trim();

            if (!name) {
                nameInput.classList.add('is-invalid');
                return;
            }
            nameInput.classList.remove('is-invalid');

            try {
                const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting/add_proposal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name: name })
                });

                if (response.ok) {
                    nameInput.value = '';
                    loadCastingData();
                } else {
                    alert('Erreur lors de la création de la proposition');
                }
            } catch (error) {
                console.error('Error adding proposal:', error);
            }
        });
    }

    async function deleteProposal(event) {
        const proposalId = event.currentTarget.dataset.proposalId;

        if (!confirm('Supprimer cette proposition et toutes ses attributions ?')) {
            return;
        }

        try {
            const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting/delete_proposal`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ proposal_id: proposalId })
            });

            if (response.ok) {
                loadCastingData();
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            console.error('Error deleting proposal:', error);
        }
    }

    // Auto-assign button
    const autoAssignBtn = document.getElementById('auto-assign-btn');
    if (autoAssignBtn) {
        autoAssignBtn.addEventListener('click', async function () {
            if (!confirm('Calculer les attributions automatiquement en fonction des scores ?\n\nCela écrasera les attributions actuelles dans la colonne "Attribution".')) {
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting/auto_assign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Attribution automatique terminée !\n${result.assigned_count} rôles attribués sur ${result.total_roles}.`);
                    loadCastingData();
                } else {
                    const error = await response.json();
                    alert(`Erreur : ${error.error || 'Erreur lors du calcul'}`);
                }
            } catch (error) {
                console.error('Error auto-assigning:', error);
                alert('Erreur lors du calcul automatique');
            }
        });
    }

    // Casting validation switch
    const validationSwitch = document.getElementById('castingValidationSwitch');
    const validationLabel = document.getElementById('castingValidationLabel');

    if (validationSwitch) {
        validationSwitch.addEventListener('change', async function () {
            const validated = this.checked;

            try {
                const response = await fetch(`${SCRIPT_ROOT}/event/${eventId}/casting/toggle_validation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ validated: validated })
                });

                const data = await response.json();
                if (data.success) {
                    if (data.is_casting_validated) {
                        validationLabel.innerHTML = '<span class="badge bg-success">Validé</span>';
                    } else {
                        validationLabel.innerHTML = '<span class="badge bg-secondary">Non-validé</span>';
                    }
                } else {
                    // Revert
                    this.checked = !this.checked;
                    alert('Erreur lors de la mise à jour');
                }
            } catch (error) {
                console.error('Error toggling validation:', error);
                this.checked = !this.checked;
                alert('Erreur lors de la mise à jour');
            }
        });
    }
});
</script>

{# Add Role Modal #}
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('event.add_role', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-header">
                    <h5 class="modal-title" id="addRoleModalLabel">
                        <i class="bi bi-plus-circle"></i> Ajouter un nouveau rôle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du rôle *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type *</label>
                            <select class="form-select role-type-select" name="type" required data-target="add">
                                <option value="">Sélectionner...</option>
                                <option value="Organisateur">Organisateur</option>
                                <option value="PJ">PJ</option>
                                <option value="PNJ">PNJ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Groupe</label>
                            <select class="form-select role-group-select" name="group" id="add-group-select" disabled>
                                <option value="">Sélectionnez d'abord un type</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Genre</label>
                            <select class="form-select" name="genre">
                                <option value="">Non spécifié</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL Google Doc</label>
                            <input type="url" class="form-control" name="google_doc_url"
                                placeholder="https://docs.google.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL PDF</label>
                            <input type="url" class="form-control" name="pdf_url" placeholder="https://...">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Commentaire</label>
                        <textarea class="form-control" name="comment" rows="2"
                            placeholder="Notes internes sur ce rôle..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check"></i> Créer le rôle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Edit Role Modals #}
{% for role in roles %}
<div class="modal fade" id="editRoleModal{{ role.id }}" tabindex="-1" aria-labelledby="editRoleModalLabel{{ role.id }}"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('event.update_role', event_id=event.id, role_id=role.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editRoleModalLabel{{ role.id }}">
                        <i class="bi bi-gear"></i> Modifier le rôle : {{ role.name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du rôle *</label>
                            <input type="text" class="form-control" name="name" value="{{ role.name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type *</label>
                            <select class="form-select role-type-select" name="type" required
                                data-target="edit{{ role.id }}">
                                <option value="">Sélectionner...</option>
                                <option value="Organisateur" {% if role.type=='Organisateur' %}selected{% endif %}>
                                    Organisateur</option>
                                <option value="PJ" {% if role.type=='PJ' %}selected{% endif %}>PJ</option>
                                <option value="PNJ" {% if role.type=='PNJ' %}selected{% endif %}>PNJ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Groupe</label>
                            <select class="form-select role-group-select" name="group"
                                id="edit{{ role.id }}-group-select" data-current="{{ role.group or '' }}">
                                <option value="">Aucun groupe</option>
                                {% if role.type and groups_config.get(role.type) %}
                                {% for grp in groups_config.get(role.type, []) %}
                                <option value="{{ grp }}" {% if role.group==grp %}selected{% endif %}>{{ grp }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Genre</label>
                            <select class="form-select" name="genre">
                                <option value="">Non spécifié</option>
                                <option value="Homme" {% if role.genre=='Homme' %}selected{% endif %}>Homme</option>
                                <option value="Femme" {% if role.genre=='Femme' %}selected{% endif %}>Femme</option>
                                <option value="Autre" {% if role.genre=='Autre' %}selected{% endif %}>Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL Google Doc</label>
                            <input type="url" class="form-control" name="google_doc_url"
                                value="{{ role.google_doc_url or '' }}" placeholder="https://docs.google.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL PDF</label>
                            <input type="url" class="form-control" name="pdf_url" value="{{ role.pdf_url or '' }}"
                                placeholder="https://...">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Commentaire</label>
                        <textarea class="form-control" name="comment" rows="2"
                            placeholder="Notes internes sur ce rôle...">{{ role.comment or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{# JavaScript for dynamic group dropdown based on type #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Groups configuration from server
        const groupsConfig = {{ groups_config | tojson | safe
    }};

    // Handle all type selects (add form and edit modals)
    document.querySelectorAll('.role-type-select').forEach(function (typeSelect) {
        typeSelect.addEventListener('change', function () {
            const target = this.dataset.target;
            const groupSelect = document.getElementById(target + '-group-select');
            const selectedType = this.value;
            const currentGroup = groupSelect.dataset.current || '';

            // Clear existing options
            groupSelect.innerHTML = '<option value="">Aucun groupe</option>';

            if (selectedType && groupsConfig[selectedType]) {
                groupSelect.disabled = false;
                groupsConfig[selectedType].forEach(function (grp) {
                    const option = document.createElement('option');
                    option.value = grp;
                    option.textContent = grp;
                    if (grp === currentGroup) {
                        option.selected = true;
                    }
                    groupSelect.appendChild(option);
                });
            } else {
                groupSelect.disabled = true;
            }
        });

        // Trigger change on page load for edit modals with existing type
        if (typeSelect.value) {
            typeSelect.dispatchEvent(new Event('change'));
        }
    });

    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Activate tab from URL hash (for redirect after role creation/update)
    const hash = window.location.hash;
    if (hash) {
        const tabTrigger = document.querySelector('[data-bs-toggle="list"][href="' + hash + '"]');
        if (tabTrigger) {
            const tab = new bootstrap.Tab(tabTrigger);
            tab.show();
        }
    }
});
</script>