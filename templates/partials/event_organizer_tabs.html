{# Organizer-only tabs content - extracted from event_detail.html #}

{# Description Tab (Organizer only) #}
<div class="tab-pane fade" id="list-general" role="tabpanel">
    <div class="card">
        <div class="card-header">Modifier les généralités</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('event.update_general', event_id=event.id) }}"
                enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <h5 class="mb-3">Informations Principales</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nom de l'événement</label>
                        <input type="text" class="form-control" name="name" value="{{ event.name }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Lieu</label>
                        <input type="text" class="form-control" name="location" value="{{ event.location }}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Image de fond (Thème Clair)</label>
                    <input type="file" class="form-control" name="background_image_light"
                        accept=".jpg,.jpeg,.png,.webp">
                    <div class="form-text">Image pour le mode clair. Formats: JPG, PNG, WEBP.</div>
                    {% if event.background_image_light %}
                    <div class="mt-2">
                        <small>Image actuelle (Clair) : <a
                                href="{{ url_for('static', filename=event.background_image_light) }}"
                                target="_blank">Voir</a></small>
                    </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label">Image de fond (Thème Sombre)</label>
                    <input type="file" class="form-control" name="background_image_dark" accept=".jpg,.jpeg,.png,.webp">
                    <div class="form-text">Image pour le mode sombre. Formats: JPG, PNG, WEBP.</div>
                    {% if event.background_image_dark %}
                    <div class="mt-2">
                        <small>Image actuelle (Sombre) : <a
                                href="{{ url_for('static', filename=event.background_image_dark) }}"
                                target="_blank">Voir</a></small>
                    </div>
                    {% endif %}
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date de début</label>
                        <input type="date" class="form-control" name="date_start"
                            value="{{ event.date_start.strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date de fin</label>
                        <input type="date" class="form-control" name="date_end"
                            value="{{ event.date_end.strftime('%Y-%m-%d') }}" required>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3">Statut de l'événement</h5>
                <div class="mb-3">
                    <select class="form-select" name="statut">
                        <option value="En préparation" {% if event.statut=='En préparation' %}selected{% endif %}>En
                            préparation</option>
                        <option value="Inscriptions ouvertes" {% if event.statut=='Inscriptions ouvertes' %}selected{%
                            endif %}>
                            Inscriptions ouvertes</option>
                        <option value="Inscriptions fermées" {% if event.statut=='Inscriptions fermées' %}selected{%
                            endif %}>
                            Inscriptions fermées</option>
                        <option value="Casting en cours" {% if event.statut=='Casting en cours' %}selected{% endif %}>
                            Casting en cours</option>
                        <option value="Casting terminé" {% if event.statut=='Casting terminé' %}selected{% endif %}>
                            Casting terminé</option>
                        <option value="Rôles en cours de préparation" {% if
                            event.statut=='Rôles en cours de préparation' %}selected{% endif %}>Rôles en cours de
                            préparation</option>
                        <option value="Rôles en cours d'envois" {% if event.statut=='Rôles en cours d\' envois'
                            %}selected{% endif %}>Rôles en cours d'envois</option>
                        <option value="Rôles envoyés, préparatifs de l'événement" {% if
                            event.statut=='Rôles envoyés, préparatifs de l\' événement' %}selected{% endif %}>Rôles
                            envoyés, préparatifs de l'événement</option>
                        <option value="Événement en cours" {% if event.statut=='Événement en cours' %}selected{% endif
                            %}>
                            Événement
                            en cours</option>
                        <option value="Terminé" {% if event.statut=='Terminé' %}selected{% endif %}>Terminé</option>
                        <option value="Annulé" {% if event.statut=='Annulé' %}selected{% endif %}>Annulé</option>
                        <option value="Reporté" {% if event.statut=='Reporté' %}selected{% endif %}>Reporté</option>
                    </select>
                </div>

                <hr>
                <h5 class="mb-3">Jauges (Participants Max)</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Organisateurs</label>
                        <div class="d-flex align-items-center">
                            {% set limit = event.max_organizers if event.max_organizers is not none else 5 %}
                            {% set org_color = 'green' if count_orgs == limit else ('#FF8C00' if count_orgs < limit
                                else 'red' ) %} <span class="fw-bold me-2"
                                style="white-space: nowrap; color: {{ org_color }}">
                                {{ count_orgs }} inscrits sur
                                </span>
                                <input type="number" class="form-control" name="max_organizers" value="{{ limit }}"
                                    min="0">
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">PJ</label>
                        <div class="d-flex align-items-center">
                            {% set limit = event.max_pjs if event.max_pjs is not none else 50 %}
                            {% set pj_color = 'green' if count_pjs == limit else ('#FF8C00' if count_pjs < limit
                                else 'red' ) %} <span class="fw-bold me-2"
                                style="white-space: nowrap; color: {{ pj_color }}">
                                {{ count_pjs }} inscrits sur
                                </span>
                                <input type="number" class="form-control" name="max_pjs" value="{{ limit }}" min="0">
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">PNJ</label>
                        <div class="d-flex align-items-center">
                            {% set limit = event.max_pnjs if event.max_pnjs is not none else 10 %}
                            {% set pnj_color = 'green' if count_pnjs == limit else ('#FF8C00' if count_pnjs < limit
                                else 'red' ) %} <span class="fw-bold me-2"
                                style="white-space: nowrap; color: {{ pnj_color }}">
                                {{ count_pnjs }} inscrits sur
                                </span>
                                <input type="number" class="form-control" name="max_pnjs" value="{{ limit }}" min="0">
                        </div>
                    </div>
                </div>
                <hr>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3">{{ event.description }}</textarea>
                </div>
                <hr>
                <h6>Liens Externes</h6>
                <div id="links-container">
                    {% for link in event.links_sorted %}
                    <div class="row mb-2 link-row">
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" name="link_urls[]"
                                placeholder="URL (https://...)" value="{{ link.url }}" required>
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" name="link_titles[]"
                                placeholder="Titre (ex: Site Web)" value="{{ link.title }}" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-link-btn"><i
                                    class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="add-link-btn"><i
                            class="bi bi-plus"></i>
                        Ajouter un lien</button>
                </div>

                <hr>
                <h6>Configuration P.A.F.</h6>
                <div id="paf-config-container">
                    {% for paf in paf_config %}
                    <div class="row mb-2 paf-row">
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" name="paf_names[]"
                                placeholder="Nom (ex: PJ Standard)" value="{{ paf.name }}" required>
                        </div>
                        <div class="col-md-5">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" name="paf_amounts[]" placeholder="Montant"
                                    value="{{ paf.amount }}" step="0.01" required>
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-paf-btn"><i
                                    class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    {% else %}
                    <!-- Default empty row if none -->
                    <div class="row mb-2 paf-row">
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" name="paf_names[]"
                                placeholder="Nom (ex: PJ Standard)" value="">
                        </div>
                        <div class="col-md-5">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" name="paf_amounts[]" placeholder="Montant"
                                    value="" step="0.01">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-paf-btn"><i
                                    class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="add-paf-btn"><i
                            class="bi bi-plus"></i> Ajouter un tarif</button>
                </div>

                <hr>
                <h6>Formulaire Google</h6>
                <div class="mb-3">
                    <label class="form-label">Configuration Webhook</label>
                    <div class="alert alert-secondary p-2">
                        <strong>API_SECRET : </strong> <code
                            class="user-select-all">{{ event.webhook_secret or 'Non généré' }}</code>
                        <div class="mt-1">
                            <a href="{{ url_for('static', filename='GOOGLE_APPS_SCRIPT.js') }}" target="_blank"
                                class="small">
                                <i class="bi bi-file-earmark-code"></i> code à mettre dans GFORMS
                            </a>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">URL Google Form</label>
                    <input type="text" class="form-control" name="google_form_url"
                        value="{{ event.google_form_url or '' }}">
                </div>
                <hr>
                <h6>Notifications Discord</h6>
                <div class="mb-3">
                    <label class="form-label">URL Webhook Discord</label>
                    <input type="text" class="form-control" name="discord_webhook_url"
                        value="{{ event.discord_webhook_url or '' }}"
                        placeholder="https://discord.com/api/webhooks/...">
                    <div class="form-text">Laissez vide pour désactiver les notifications Discord.</div>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('links-container');
        const addBtn = document.getElementById('add-link-btn');

        // Add new link row
        addBtn.addEventListener('click', function () {
            const row = document.createElement('div');
            row.className = 'row mb-2 link-row';
            row.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control form-control-sm" name="link_urls[]" placeholder="URL (https://...)" value="">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control form-control-sm" name="link_titles[]" placeholder="Titre (ex: Site Web)" value="">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-link-btn"><i class="bi bi-trash"></i></button>
            </div>
        `;
            container.appendChild(row);
            attachRemoveListeners();
        });

        function attachRemoveListeners() {
            document.querySelectorAll('.remove-link-btn').forEach(btn => {
                btn.onclick = function () {
                    // remove row but keep at least one if we want? No, allowing empty is fine, but maybe validation implies at least one?
                    // The backend filters out empty strings, so removing all is fine.
                    this.closest('.link-row').remove();
                };
            });
        }

        attachRemoveListeners();
    });
</script>

{# Groups Configuration Tab (Organizer only) #}
<div class="tab-pane fade" id="list-groups" role="tabpanel">
    <div class="card">
        <div class="card-header">Configuration des groupes</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('event.update_groups', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <p class="text-muted">Séparez les groupes par des virgules. Exemple : Groupe A, Groupe B, Groupe C
                </p>
                <div class="mb-3">
                    <label class="form-label">Groupes PJ</label>
                    <input type="text" class="form-control" name="groups_pj"
                        value="{{ groups_config.get('PJ', [])|join(', ') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Groupes PNJ</label>
                    <input type="text" class="form-control" name="groups_pnj"
                        value="{{ groups_config.get('PNJ', [])|join(', ') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Groupes Organisateurs</label>
                    <input type="text" class="form-control" name="groups_org"
                        value="{{ groups_config.get('Organisateur', [])|join(', ') }}">
                </div>

                <button type="submit" class="btn btn-primary">Enregistrer la configuration</button>
            </form>
        </div>
    </div>
</div>

{# Roles Tab (Organizer only) #}
<div class="tab-pane fade" id="list-roles" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Gestion des Rôles</span>
            <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addRoleModal">
                <i class="bi bi-plus"></i> Ajouter un rôle
            </button>
        </div>
        <div class="card-body">
            {# Roles Table #}
            {% if roles and roles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Genre</th>
                            <th>Groupe</th>
                            <th>GDoc</th>
                            <th>PDF</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr>
                            <td>
                                {% if role.comment %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ role.comment }}">
                                    {{ role.name }} <i class="bi bi-info-circle text-muted small"></i>
                                </span>
                                {% else %}
                                {{ role.name }}
                                {% endif %}
                            </td>
                            <td>
                                {% if role.type == 'Organisateur' %}
                                <span class="badge bg-warning text-dark">{{ role.type }}</span>
                                {% elif role.type == 'PJ' %}
                                <span class="badge bg-success">{{ role.type }}</span>
                                {% elif role.type == 'PNJ' %}
                                <span class="badge bg-info">{{ role.type }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ role.genre or '-' }}</td>
                            <td>{{ role.group or '-' }}</td>
                            <td>
                                {% if role.google_doc_url %}
                                <a href="{{ role.google_doc_url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-text"></i> gdoc
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if role.pdf_url %}
                                <a href="{{ role.pdf_url }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-file-pdf"></i> pdf
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-secondary me-1"
                                    data-bs-toggle="modal" data-bs-target="#editRoleModal{{ role.id }}"
                                    title="Modifier ce rôle">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteRoleModal{{ role.id }}" title="Supprimer ce rôle">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-person-badge" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucun rôle défini pour cet événement.</p>
                <p class="small">Cliquez sur "Ajouter un rôle" pour commencer.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Casting Tab (Organizer only) #}
<div class="tab-pane fade" id="casting-container" role="tabpanel" data-event-id="{{ event.id }}"
    data-csrf-token="{{ csrf_token() }}">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <span><i class="bi bi-person-video2"></i> Casting</span>
                {# Validation Switch #}
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="castingValidationSwitch" {% if
                            event.is_casting_validated %}checked{% endif %}>
                        <label class="form-check-label" for="castingValidationSwitch" id="castingValidationLabel">
                            {% if event.is_casting_validated %}
                            <span class="badge bg-success">Validé</span>
                            {% else %}
                            <span class="badge bg-secondary">Non-validé</span>
                            {% endif %}
                        </label>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <div class="input-group input-group-sm" style="max-width: 300px;">
                    <input type="text" class="form-control" id="new-proposal-name"
                        placeholder="Nom de la proposition...">
                    <button class="btn btn-primary" type="button" id="add-proposal-btn">
                        <i class="bi bi-plus"></i> Ajouter une proposition
                    </button>
                </div>

            </div>
        </div>
        <div class="card-body">
            {% if roles and roles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="casting-table">
                    <thead>
                        <tr>
                            <th style="min-width: 150px;">Rôle</th>
                            <th style="min-width: 80px;">Type</th>
                            <th style="min-width: 200px;" class="proposal-column" data-proposal-id="main">Attribution
                            </th>
                            {# Dynamic proposal columns will be added here by JavaScript #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr data-role-id="{{ role.id }}" data-role-type="{{ role.type }}">
                            <td>
                                {% if role.comment %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ role.comment }}">
                                    {{ role.name }} <i class="bi bi-info-circle text-muted small"></i>
                                </span>
                                {% else %}
                                {{ role.name }}
                                {% endif %}
                            </td>
                            <td>
                                {% if role.type == 'Organisateur' %}
                                <span class="badge bg-warning text-dark">{{ role.type }}</span>
                                {% elif role.type == 'PJ' %}
                                <span class="badge bg-success">{{ role.type }}</span>
                                {% elif role.type == 'PNJ' %}
                                <span class="badge bg-info">{{ role.type }}</span>
                                {% else %}
                                <span class="badge bg-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="assignment-cell" data-proposal-id="main">
                                <select class="form-select form-select-sm casting-select" data-role-id="{{ role.id }}"
                                    data-proposal-id="main" data-role-type="{{ role.type }}">
                                    <option value="">-- Non attribué --</option>
                                </select>
                            </td>
                            {# Dynamic proposal cells will be added here by JavaScript #}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-person-video2" style="font-size: 3rem;"></i>
                <p class="mt-2">Aucun rôle défini pour cet événement.</p>
                <p class="small">Créez d'abord des rôles dans l'onglet "Rôles" pour utiliser le casting.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>


{# Add Role Modal #}
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('event.add_role', event_id=event.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-header">
                    <h5 class="modal-title" id="addRoleModalLabel">
                        <i class="bi bi-plus-circle"></i> Ajouter un nouveau rôle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du rôle *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type *</label>
                            <select class="form-select role-type-select" name="type" required data-target="add">
                                <option value="">Sélectionner...</option>
                                <option value="Organisateur">Organisateur</option>
                                <option value="PJ">PJ</option>
                                <option value="PNJ">PNJ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Groupe</label>
                            <select class="form-select role-group-select" name="group" id="add-group-select" disabled>
                                <option value="">Sélectionnez d'abord un type</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Genre</label>
                            <select class="form-select" name="genre">
                                <option value="">Non spécifié</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL Google Doc</label>
                            <input type="url" class="form-control" name="google_doc_url"
                                placeholder="https://docs.google.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL PDF</label>
                            <input type="url" class="form-control" name="pdf_url" placeholder="https://...">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Commentaire</label>
                        <textarea class="form-control" name="comment" rows="2"
                            placeholder="Notes internes sur ce rôle..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check"></i> Créer le rôle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Edit Role Modals #}
{% for role in roles %}
<div class="modal fade" id="editRoleModal{{ role.id }}" tabindex="-1" aria-labelledby="editRoleModalLabel{{ role.id }}"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('event.update_role', event_id=event.id, role_id=role.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editRoleModalLabel{{ role.id }}">
                        <i class="bi bi-gear"></i> Modifier le rôle : {{ role.name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nom du rôle *</label>
                            <input type="text" class="form-control" name="name" value="{{ role.name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type *</label>
                            <select class="form-select role-type-select" name="type" required
                                data-target="edit{{ role.id }}">
                                <option value="">Sélectionner...</option>
                                <option value="Organisateur" {% if role.type=='Organisateur' %}selected{% endif %}>
                                    Organisateur</option>
                                <option value="PJ" {% if role.type=='PJ' %}selected{% endif %}>PJ</option>
                                <option value="PNJ" {% if role.type=='PNJ' %}selected{% endif %}>PNJ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Groupe</label>
                            <select class="form-select role-group-select" name="group"
                                id="edit{{ role.id }}-group-select" data-current="{{ role.group or '' }}">
                                <option value="">Aucun groupe</option>
                                {% if role.type and groups_config.get(role.type) %}
                                {% for grp in groups_config.get(role.type, []) %}
                                <option value="{{ grp }}" {% if role.group==grp %}selected{% endif %}>{{ grp }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Genre</label>
                            <select class="form-select" name="genre">
                                <option value="">Non spécifié</option>
                                <option value="Homme" {% if role.genre=='Homme' %}selected{% endif %}>Homme</option>
                                <option value="Femme" {% if role.genre=='Femme' %}selected{% endif %}>Femme</option>
                                <option value="Autre" {% if role.genre=='Autre' %}selected{% endif %}>Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL Google Doc</label>
                            <input type="url" class="form-control" name="google_doc_url"
                                value="{{ role.google_doc_url or '' }}" placeholder="https://docs.google.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL PDF</label>
                            <input type="url" class="form-control" name="pdf_url" value="{{ role.pdf_url or '' }}"
                                placeholder="https://...">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Commentaire</label>
                        <textarea class="form-control" name="comment" rows="2"
                            placeholder="Notes internes sur ce rôle...">{{ role.comment or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Delete Role Modal #}
<div class="modal fade" id="deleteRoleModal{{ role.id }}" tabindex="-1"
    aria-labelledby="deleteRoleModalLabel{{ role.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteRoleModalLabel{{ role.id }}">
                    <i class="bi bi-exclamation-triangle"></i> Supprimer le rôle ?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer le rôle <strong>{{ role.name }}</strong> ?</p>
                <p class="text-muted small">Cette action est irréversible.</p>

                {% set assigned_p = role.assigned_participant %}
                {# DEBUG: Count = {{ role.casting_assignments|length }} #}
                {# Filter casting assignments that have a participant #}
                {% set proposed_assignments = [] %}
                {% for ca in role.casting_assignments %}
                {% if ca.participant_id or ca.score %}
                {% do proposed_assignments.append(ca) %}
                {% endif %}
                {% endfor %}

                {% if assigned_p or proposed_assignments|length > 0 %}
                <div class="alert alert-warning d-flex align-items-start mt-3">
                    <i class="bi bi-exclamation-circle-fill me-2 fs-5"></i>
                    <div>
                        <strong>Attention :</strong><br>

                        {% if assigned_p %}
                        Ce rôle est attribué à <strong>{{ assigned_p.user.prenom }} {{ assigned_p.user.nom }}</strong>
                        (Principal).<br>
                        {% endif %}

                        {% for assignment in proposed_assignments %}
                        {% if assignment.participant_id %}
                        Ce rôle est proposé à <strong>{{ assignment.participant.user.prenom }} {{
                            assignment.participant.user.nom }}</strong>
                        (Proposition : {{ assignment.proposal.name }}).<br>
                        {% elif assignment.score %}
                        Ce rôle a un score de <strong>{{ assignment.score }}</strong>
                        (Proposition : {{ assignment.proposal.name }}).<br>
                        {% endif %}
                        {% endfor %}

                        <div class="mt-2 text-dark small">La suppression annulera ces attributions.</div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form method="POST" action="{{ url_for('event.delete_role', event_id=event.id, role_id=role.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Confirmer la suppression
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}


{# Groups configuration data - passed as JSON for external JavaScript #}
<script type="application/json" id="groups-config-data">{{ groups_config | tojson }}</script>

{# Event Organizer JavaScript - Loaded from external file #}
<script src="{{ url_for('static', filename='js/event_organizer.js') }}"></script>
{# Casting JavaScript - Loaded from external file #}
<script src="{{ url_for('static', filename='js/casting.js') }}"></script>
{% include "partials/casting_templates.html" %}

{# P.A.F. Management Tab Content #}
<div class="tab-pane fade" id="list-paf" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Gestion de la P.A.F.</span>
            <span class="badge bg-primary">{{ event.participants|length }} Participants</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Participant</th>
                            <th>Email</th>
                            <th>État</th>
                            <th>Versé</th>
                            <th>Type PAF (Sélection)</th>
                            <th>Dû</th>
                            <th>Reste</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in event.participants %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if p.user.avatar_url %}
                                    <img src="{{ p.user.avatar_url }}" class="rounded-circle me-2" width="32"
                                        height="32" style="object-fit: cover;">
                                    {% else %}
                                    <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2"
                                        style="width: 32px; height: 32px;">
                                        {{ p.user.prenom[0] if p.user.prenom else '?' }}{{ p.user.nom[0] if p.user.nom
                                        else '?' }}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-bold">{{ p.user.nom }} {{ p.user.prenom }}</div>
                                        <small class="text-muted">{{ p.type }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ p.user.email }}</td>
                            <td>
                                {% set paf_color = 'danger' %}
                                {% if p.paf_status == 'versée' %}{% set paf_color = 'success' %}
                                {% elif p.paf_status == 'partielle' %}{% set paf_color = 'warning text-dark' %}
                                {% endif %}
                                <span class="badge bg-{{ paf_color }}">{{ p.paf_status|capitalize }}</span>
                            </td>
                            <td>{{ "%.2f"|format(p.payment_amount) }} €</td>
                            <td>
                                <form action="{{ url_for('participant.update_paf', event_id=event.id, p_id=p.id) }}"
                                    method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <select class="form-select form-select-sm" name="paf_type"
                                        onchange="this.form.submit()">
                                        <option value="" {% if not p.paf_type %}selected{% endif %}>Selectionner...
                                        </option>
                                        {% for conf in paf_config %}
                                        <option value="{{ conf.name }}" {% if p.paf_type==conf.name %}selected{% endif
                                            %}>
                                            {{ conf.name }} ({{ conf.amount }} €)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </td>
                            <td>
                                {% set due = paf_map.get(p.paf_type, 0) %}
                                <span class="fw-bold">{{ "%.2f"|format(due) }} €</span>
                            </td>
                            <td>
                                {% set remaining = due - p.payment_amount %}
                                {% if remaining > 0.01 %}
                                <span class="text-danger fw-bold">{{ "%.2f"|format(remaining) }} €</span>
                                {% elif remaining < -0.01 %} <span class="text-success">{{ "%.2f"|format(remaining) }} €
                                    (Trop perçu)</span>
                                    {% else %}
                                    <span class="text-success"><i class="bi bi-check-lg"></i> Payé</span>
                                    {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Dynamic PAF Configuration Rows
        const pafContainer = document.getElementById('paf-config-container');
        const addPafBtn = document.getElementById('add-paf-btn');

        if (pafContainer && addPafBtn) {
            addPafBtn.addEventListener('click', function () {
                const row = document.createElement('div');
                row.className = 'row mb-2 paf-row';
                row.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm" name="paf_names[]" placeholder="Nom (ex: PJ Standard)" value="">
                </div>
                <div class="col-md-5">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" name="paf_amounts[]" placeholder="Montant" value="" step="0.01">
                        <span class="input-group-text">€</span>
                    </div>
                </div>
                <div class="col-md-2">
                     <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-paf-btn"><i class="bi bi-trash"></i></button>
                </div>
            `;
                pafContainer.appendChild(row);
            });

            pafContainer.addEventListener('click', function (e) {
                if (e.target.closest('.remove-paf-btn')) {
                    const row = e.target.closest('.paf-row');
                    // Don't remove if it's the only row? logic: allow removing but maybe keep one? 
                    // Let's rely on backend ignoring empty ones, so removing is fine.
                    // If container becomes empty, maybe user can add again.
                    row.remove();
                }
            });
        }
    });
</script>