{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- Sidebar Menu (20%) -->
    <div class="col-md-2 mb-3">
        <div class="list-group" id="event-tabs" role="tablist">
            <a class="list-group-item list-group-item-action active" id="list-info-list" data-bs-toggle="list"
                href="#list-info" role="tab">Informations</a>
            {% if is_organizer %}
            <a class="list-group-item list-group-item-action" id="list-general-list" data-bs-toggle="list"
                href="#list-general" role="tab">Généralités</a>
            <a class="list-group-item list-group-item-action" id="list-status-list" data-bs-toggle="list"
                href="#list-status" role="tab">Statut</a>
            <a class="list-group-item list-group-item-action" id="list-groups-list" data-bs-toggle="list"
                href="#list-groups" role="tab">Configuration Groupes</a>
            <a class="list-group-item list-group-item-action" href="/event/{{ event.id }}/participants">Participants</a>
            {% endif %}
        </div>
    </div>

    <!-- Content Area (80%) -->
    <div class="col-md-10">
        <div class="tab-content" id="nav-tabContent">

            <!-- Informations Tab -->
            <div class="tab-pane fade show active" id="list-info" role="tabpanel">
                <div class="card mb-4">
                    {% if event.background_image %}
                    <img src="{{ event.background_image }}" class="card-img-top" alt="Event Image"
                        style="height: 200px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <!-- 1. Titre -->
                        <h1 class="card-title">{{ event.name }}</h1>

                        <!-- 2. Date -->
                        <p class="text-muted">
                            Du {{ event.date_start.strftime('%d/%m/%Y') }} au {{ event.date_end.strftime('%d/%m/%Y')
                            }}<br>
                            {{ event.location }}
                        </p>

                        <!-- 3. Description -->
                        <p class="mt-3">{{ event.description }}</p>

                        <!-- 4. Statut Actuel -->
                        <p>Status actuel : <span class="badge bg-info">{{ event.statut }}</span></p>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% if event.org_link_url %}
                            <a href="{{ event.org_link_url }}" target="_blank" class="btn btn-outline-secondary">
                                <i class="bi bi-link-45deg"></i> {{ event.org_link_title or 'Lien externe' }}
                            </a>
                            {% endif %}

                            {% if event.google_form_url %}
                            <a href="{{ event.google_form_url }}" target="_blank" class="btn btn-outline-primary">
                                <i class="bi bi-journal-check"></i> Google Form
                            </a>
                            {% endif %}
                        </div>

                        <!-- 5. Statut Utilisateur / Boutons -->
                        {% if participant %}
                        <!-- Cas: Utilisateur participe déjà -->

                        {% if is_organizer %}
                        <div class="alert alert-warning mb-2">Vous êtes organisateur de cet événement.</div>
                        {% endif %}

                        {% if participant.type %}
                        {% set badge_class = "bg-secondary" %}
                        {% if participant.type.lower() == 'organisateur' %}
                        {% set badge_class = "bg-danger" %}
                        {% elif participant.type == 'PJ' %}
                        {% set badge_class = "bg-success" %}
                        {% elif participant.type == 'PNJ' %}
                        {% set badge_class = "bg-primary" %}
                        {% endif %}

                        <div class="mt-3">
                            <p class="mb-1">Votre statut :</p>
                            {% if participant.registration_status == 'En attente' or participant.registration_status
                            == 'À valider' %}
                            <span class="badge bg-light text-dark border fs-6">
                                {{ participant.type }} (En Attente)
                            </span>
                            {% else %}
                            <span class="badge {{ badge_class }} fs-6">
                                {{ participant.type }}
                                {% if participant.group and participant.group != 'Peu importe' %}
                                - {{ participant.group }}
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}
                        <p class="mt-2 text-muted"><small>Statut inscription : {{ participant.registration_status
                                }}</small></p>

                        {% else %}
                        <!-- Cas: Utilisateur ne participe pas encore -->

                        {% if event.statut == 'Inscriptions ouvertes' %}
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal"
                            data-bs-target="#joinModal">
                            Rejoindre l'événement
                        </button>

                        {% elif event.statut in ['En préparation', 'Inscriptions fermées', 'Casting en cours',
                        'Casting terminé', 'Rôles en cours de préparation', 'Rôles en cours d\'envois', 'Rôles
                        envoyés, préparatifs de l\'événement'] %}
                        <!-- Avant "Événement en cours" mais pas "Inscriptions ouvertes" -->
                        <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal"
                            data-bs-target="#joinModal">
                            J'aimerais participer
                        </button>

                        {% else %}
                        <!-- Statuts: Événement en cours, Terminé, Annulé, Reporté -->
                        <!-- Aucun bouton affiché -->
                        {% if event.statut == 'Annulé' %}
                        <button class="btn btn-secondary" disabled>Événement annulé</button>
                        {% elif event.statut == 'Terminé' %}
                        <button class="btn btn-secondary" disabled>Événement clôturé</button>
                        {% endif %}
                        {% endif %}

                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Title Tab (Organizer only) -->
            <!-- Generalites Tab (Organizer only) -->
            {% if is_organizer %}
            <div class="tab-pane fade" id="list-general" role="tabpanel">
                <div class="card">
                    <div class="card-header">Modifier les généralités</div>
                    <div class="card-body">
                        <form method="POST" action="/event/{{ event.id }}/update_general">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div class="mb-3">
                                <label class="form-label">Titre de l'événement</label>
                                <input type="text" class="form-control" name="name" value="{{ event.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lieu</label>
                                <input type="text" class="form-control" name="location" value="{{ event.location }}">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date de début</label>
                                    <input type="date" class="form-control" name="date_start"
                                        value="{{ event.date_start.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date de fin</label>
                                    <input type="date" class="form-control" name="date_end"
                                        value="{{ event.date_end.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description"
                                    rows="3">{{ event.description }}</textarea>
                            </div>
                            <hr>
                            <h6>Liens Externes</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Lien externe (URL)</label>
                                    <input type="text" class="form-control" name="org_link_url"
                                        value="{{ event.org_link_url or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Titre du lien externe</label>
                                    <input type="text" class="form-control" name="org_link_title"
                                        value="{{ event.org_link_title or '' }}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lien Google Form (Inscription)</label>
                                <input type="text" class="form-control" name="google_form_url"
                                    value="{{ event.google_form_url or '' }}">
                            </div>
                            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Status Tab (Organizer only) -->
            <div class="tab-pane fade" id="list-status" role="tabpanel">
                <div class="card">
                    <div class="card-header">Statut de l'événement</div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            Statut actuel : <strong>{{ event.statut }}</strong>
                        </div>
                        <form method="POST" action="/event/{{ event.id }}/update_status">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div class="list-group mb-3">
                                {% set statuses = [
                                'En préparation',
                                'Inscriptions ouvertes',
                                'Inscriptions fermées',
                                'Casting en cours',
                                'Casting terminé',
                                'Rôles en cours de préparation',
                                'Rôles en cours d\'envois',
                                'Rôles envoyés, préparatifs de l\'événement',
                                'Événement en cours',
                                'Terminé',
                                'Annulé',
                                'Reporté'
                                ] %}
                                {% for s in statuses %}
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="radio" name="statut" value="{{ s }}" {%
                                        if event.statut|lower==s|lower %}checked{% endif %}>
                                    {{ s }}
                                </label>
                                {% endfor %}
                            </div>
                            <p class="text-muted small">Les statuts "En cours" et "Terminé" sont automatiques selon
                                les
                                dates.</p>
                            <button type="submit" class="btn btn-primary">Mettre à jour</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Dates Tab (Organizer only) -->



            <!-- Groups Tab (Organizer only) -->
            <div class="tab-pane fade" id="list-groups" role="tabpanel">
                <div class="card">
                    <div class="card-header">Configuration des Groupes</div>
                    <div class="card-body">
                        <form method="POST" action="/event/{{ event.id }}/update_groups">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div class="alert alert-info">
                                <small>Définissez ici les listes de choix de groupes pour chaque type de
                                    participant.
                                    Séparez les valeurs par des virgules.</small><br>
                                <small><strong>Exemple:</strong> <em>Garde de Nuit, Sauvageons, Marcheurs
                                        Blancs</em></small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Groupes pour les PJ</label>
                                <input type="text" class="form-control" name="groups_pj"
                                    value="{{ groups_config.get('PJ', [])|join(', ') }}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Groupes pour les PNJ</label>
                                <input type="text" class="form-control" name="groups_pnj"
                                    value="{{ groups_config.get('PNJ', [])|join(', ') }}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Groupes pour les Organisateurs</label>
                                <input type="text" class="form-control" name="groups_org"
                                    value="{{ groups_config.get('Organisateur', [])|join(', ') }}">
                            </div>

                            <button type="submit" class="btn btn-primary">Enregistrer la configuration</button>
                        </form>
                    </div>
                </div>
            </div>

            {% endif %}

        </div>
    </div>
</div>
</div>

<!-- Join Modal -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinModalLabel">Inscription à {{ event.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/event/{{ event.id }}/join" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Type d'inscription</label>
                        <select name="type" class="form-select" id="joinTypeSelect" onchange="updateGroupOptions()">
                            <option value="PJ">PJ</option>
                            <option value="PNJ">PNJ</option>
                            <option value="Organisateur">Organisateur</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Groupe souhaité</label>
                        <select name="group" class="form-select" id="joinGroupSelect">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Valider ma demande</button>
                </div>
            </form>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script id="groups-config-data" type="application/json">
    {{ groups_config| tojson }}
</script>
    <script>
        const groupsConfig = JSON.parse(document.getElementById('groups-config-data').textContent);

        function updateGroupOptions() {
            const typeSelect = document.getElementById('joinTypeSelect');
            const groupSelect = document.getElementById('joinGroupSelect');
            const selectedType = typeSelect.value;

            // Clear options
            groupSelect.innerHTML = '';

            // Get groups for this type
            let groups = [];
            if (selectedType === 'PJ') groups = groupsConfig.PJ || [];
            else if (selectedType === 'PNJ') groups = groupsConfig.PNJ || [];
            else if (selectedType === 'Organisateur') groups = groupsConfig.Organisateur || []; // Case sensitive match with key

            // Default if empty
            if (groups.length === 0) groups = ['Peu importe'];

            // Populate
            groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                groupSelect.appendChild(opt);
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', updateGroupOptions);
    </script>
    {% endblock %}