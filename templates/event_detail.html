{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- Sidebar Menu (20%) -->
    <div class="col-md-2 mb-3">
        <div class="list-group" id="event-tabs" role="tablist">
            <a class="list-group-item list-group-item-action active" id="list-info-list" data-bs-toggle="list"
                href="#list-info" role="tab">Informations</a>
            {% if is_organizer %}
            <a class="list-group-item list-group-item-action" id="list-general-list" data-bs-toggle="list"
                href="#list-general" role="tab">Généralités</a>
            <a class="list-group-item list-group-item-action" id="list-status-list" data-bs-toggle="list"
                href="#list-status" role="tab">Statut</a>
            <a class="list-group-item list-group-item-action" id="list-groups-list" data-bs-toggle="list"
                href="#list-groups" role="tab">Configuration Groupes</a>
            <a class="list-group-item list-group-item-action" href="/event/{{ event.id }}/participants">Participants</a>
            {% endif %}
        </div>
    </div>

    <!-- Content Area (80%) -->
    <div class="col-md-10">
        <div class="tab-content" id="nav-tabContent">

            <!-- Informations Tab -->
            <div class="tab-pane fade show active" id="list-info" role="tabpanel">
                <div class="card mb-4">
                    {% if event.background_image %}
                    <img src="{{ event.background_image }}" class="card-img-top" alt="Event Image"
                        style="height: 200px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <h1 class="card-title">{{ event.name }}</h1>
                        <p class="text-muted">
                            Du {{ event.date_start.strftime('%d/%m/%Y') }} au {{ event.date_end.strftime('%d/%m/%Y')
                            }}<br>
                            {{ event.location }}
                        </p>
                        <p>Status actuel : <span class="badge bg-info">{{ event.statut }}</span></p>
                        <p class="mt-3">{{ event.description }}</p>
                        {% if event.external_link %}
                        <a href="{{ event.external_link }}" target="_blank"
                            class="btn btn-outline-primary mb-3">Formulaire Externe</a>
                        {% endif %}

                        {% if is_organizer %}
                        <div class="alert alert-warning">Vous êtes organisateur de cet événement.</div>
                        {% endif %}

                        {% if participant %}
                        {% if participant.type %}
                        {% set badge_class = "bg-secondary" %}
                        {% if participant.type.lower() == 'organisateur' %}
                        {% set badge_class = "bg-danger" %}
                        {% elif participant.type == 'PJ' %}
                        {% set badge_class = "bg-success" %}
                        {% elif participant.type == 'PNJ' %}
                        {% set badge_class = "bg-primary" %}
                        {% endif %}

                        <p>Votre rôle :
                            <span class="badge {{ badge_class }}">
                                {{ participant.type }}
                                {% if participant.group and participant.group != 'Peu importe' %}
                                - {{ participant.group }}
                                {% endif %}
                            </span>
                        </p>
                        {% endif %}
                        <p>Statut inscription : {{ participant.registration_status }}</p>
                        {% elif event.statut == 'Annulé' %}
                        <button class="btn btn-secondary" disabled>Événement annulé</button>
                        {% else %}
                        <button type="button" class="btn btn-success" data-bs-toggle="modal"
                            data-bs-target="#joinModal">
                            Rejoindre l'événement
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Title Tab (Organizer only) -->
            <!-- Generalites Tab (Organizer only) -->
            {% if is_organizer %}
            <div class="tab-pane fade" id="list-general" role="tabpanel">
                <div class="card">
                    <div class="card-header">Modifier les généralités</div>
                    <div class="card-body">
                        <form method="POST" action="/event/{{ event.id }}/update_general">
                            <div class="mb-3">
                                <label class="form-label">Titre de l'événement</label>
                                <input type="text" class="form-control" name="name" value="{{ event.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lieu</label>
                                <input type="text" class="form-control" name="location" value="{{ event.location }}">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date de début</label>
                                    <input type="date" class="form-control" name="date_start"
                                        value="{{ event.date_start.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date de fin</label>
                                    <input type="date" class="form-control" name="date_end"
                                        value="{{ event.date_end.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description"
                                    rows="3">{{ event.description }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lien externe (Google Form...)</label>
                                <input type="text" class="form-control" name="external_link"
                                    value="{{ event.external_link or '' }}">
                            </div>
                            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Status Tab (Organizer only) -->
            <div class="tab-pane fade" id="list-status" role="tabpanel">
                <div class="card">
                    <div class="card-header">Statut de l'événement</div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            Statut actuel : <strong>{{ event.statut }}</strong>
                        </div>
                        <form method="POST" action="/event/{{ event.id }}/update_status">
                            <div class="list-group mb-3">
                                {% set statuses = [
                                'En préparation',
                                'Inscriptions ouvertes',
                                'Inscriptions fermées',
                                'Casting en cours',
                                'Casting terminé',
                                'Rôles en cours de préparation',
                                'Rôles en cours d\'envois',
                                'Rôles envoyés, préparatifs de l\'événement',
                                'Événement en cours',
                                'Terminé',
                                'Annulé',
                                'Reporté'
                                ] %}
                                {% for s in statuses %}
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="radio" name="statut" value="{{ s }}" {%
                                        if event.statut==s %}checked{% endif %}>
                                    {{ s|capitalize }}
                                </label>
                                {% endfor %}
                            </div>
                            <p class="text-muted small">Les statuts "En cours" et "Terminé" sont automatiques selon les
                                dates.</p>
                            <button type="submit" class="btn btn-primary">Mettre à jour</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Dates Tab (Organizer only) -->



            <!-- Groups Tab (Organizer only) -->
            <div class="tab-pane fade" id="list-groups" role="tabpanel">
                <div class="card">
                    <div class="card-header">Configuration des Groupes</div>
                    <div class="card-body">
                        <form method="POST" action="/event/{{ event.id }}/update_groups">
                            <div class="alert alert-info">
                                <small>Définissez ici les listes de choix de groupes pour chaque type de participant.
                                    Séparez les valeurs par des virgules.</small><br>
                                <small><strong>Exemple:</strong> <em>Garde de Nuit, Sauvageons, Marcheurs
                                        Blancs</em></small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Groupes pour les PJ</label>
                                <input type="text" class="form-control" name="groups_pj"
                                    value="{{ groups_config.get('PJ', [])|join(', ') }}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Groupes pour les PNJ</label>
                                <input type="text" class="form-control" name="groups_pnj"
                                    value="{{ groups_config.get('PNJ', [])|join(', ') }}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Groupes pour les Organisateurs</label>
                                <input type="text" class="form-control" name="groups_org"
                                    value="{{ groups_config.get('Organisateur', [])|join(', ') }}">
                            </div>

                            <button type="submit" class="btn btn-primary">Enregistrer la configuration</button>
                        </form>
                    </div>
                </div>
            </div>

            {% endif %}

        </div>
    </div>
</div>
</div>

<!-- Join Modal -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinModalLabel">Inscription à {{ event.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/event/{{ event.id }}/join" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Type d'inscription</label>
                        <select name="type" class="form-select" id="joinTypeSelect" onchange="updateGroupOptions()">
                            <option value="PJ">PJ</option>
                            <option value="PNJ">PNJ</option>
                            <option value="Organisateur">Organisateur</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Groupe souhaité</label>
                        <select name="group" class="form-select" id="joinGroupSelect">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Valider ma demande</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const groupsConfig = {{ groups_config| tojson }};

    function updateGroupOptions() {
        const typeSelect = document.getElementById('joinTypeSelect');
        const groupSelect = document.getElementById('joinGroupSelect');
        const selectedType = typeSelect.value;

        // Clear options
        groupSelect.innerHTML = '';

        // Get groups for this type
        let groups = [];
        if (selectedType === 'PJ') groups = groupsConfig.PJ || [];
        else if (selectedType === 'PNJ') groups = groupsConfig.PNJ || [];
        else if (selectedType === 'Organisateur') groups = groupsConfig.Organisateur || []; // Case sensitive match with key

        // Default if empty
        if (groups.length === 0) groups = ['Peu importe'];

        // Populate
        groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g;
            opt.textContent = g;
            groupSelect.appendChild(opt);
        });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', updateGroupOptions);
</script>
{% endblock %}