{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- Sidebar Menu (20%) -->
    <div class="col-md-2 mb-3">
        <div class="list-group" id="event-tabs" role="tablist">
            <a class="list-group-item list-group-item-action active" id="list-info-list" data-bs-toggle="list"
                href="#list-info" role="tab">Informations</a>
            {% if is_organizer %}
            <a class="list-group-item list-group-item-action" id="list-title-list" data-bs-toggle="list"
                href="#list-title" role="tab">Le Titre</a>
            <a class="list-group-item list-group-item-action" id="list-status-list" data-bs-toggle="list"
                href="#list-status" role="tab">Statut</a>
            <a class="list-group-item list-group-item-action" id="list-dates-list" data-bs-toggle="list"
                href="#list-dates" role="tab">Les dates</a>
            <a class="list-group-item list-group-item-action" href="/event/{{ event.id }}/participants">Participants</a>
            {% endif %}
        </div>
    </div>

    <!-- Content Area (80%) -->
    <div class="col-md-10">
        <div class="tab-content" id="nav-tabContent">

            <!-- Informations Tab -->
            <div class="tab-pane fade show active" id="list-info" role="tabpanel">
                <div class="card mb-4">
                    {% if event.background_image %}
                    <img src="{{ event.background_image }}" class="card-img-top" alt="Event Image"
                        style="height: 200px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <h1 class="card-title">{{ event.name }}</h1>
                        <p class="text-muted">
                            Du {{ event.date_start.strftime('%d/%m/%Y') }} au {{ event.date_end.strftime('%d/%m/%Y')
                            }}<br>
                            {{ event.location }}
                        </p>
                        <p>Status actuel : <span class="badge bg-info">{{ event.computed_status }}</span></p>

                        {% if is_organizer %}
                        <div class="alert alert-warning">Vous êtes organisateur de cet événement.</div>
                        {% endif %}

                        {% if participant %}
                        <p>Votre rôle : {{ participant.type }}</p>
                        {% elif event.computed_status == 'annulé' %}
                        <button class="btn btn-secondary" disabled>Événement annulé</button>
                        {% else %}
                        <form action="/event/{{ event.id }}/join" method="POST">
                            <button type="submit" class="btn btn-success">Rejoindre l'événement</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Title Tab (Organizer only) -->
            {% if is_organizer %}
            <div class="tab-pane fade" id="list-title" role="tabpanel">
                <div class="card">
                    <div class="card-header">Modifier le titre</div>
                    <div class="card-body">
                        <div id="title-display">
                            <h3>{{ event.name }}</h3>
                            <button class="btn btn-primary" onclick="toggleTitleEdit()">Modifier</button>
                        </div>
                        <div id="title-edit" style="display: none;">
                            <form method="POST" action="/event/{{ event.id }}/update_title">
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="name" value="{{ event.name }}"
                                        required>
                                </div>
                                <button type="submit" class="btn btn-success">Valider</button>
                                <button type="button" class="btn btn-secondary"
                                    onclick="toggleTitleEdit()">Annuler</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Tab (Organizer only) -->
            <div class="tab-pane fade" id="list-status" role="tabpanel">
                <div class="card">
                    <div class="card-header">Statut de l'événement</div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            Statut actuel (calculé) : <strong>{{ event.computed_status }}</strong>
                        </div>
                        <form method="POST" action="/event/{{ event.id }}/update_status">
                            <div class="list-group mb-3">
                                {% set statuses = [
                                'en préparation',
                                'inscriptions ouvertes',
                                'inscriptions fermées - casting en cours',
                                'casting terminé - finalisation des préparations',
                                'annulé',
                                'reporté à une date indéfinie'
                                ] %}
                                {% for s in statuses %}
                                <label class="list-group-item">
                                    <input class="form-check-input me-1" type="radio" name="status" value="{{ s }}" {%
                                        if event.status==s %}checked{% endif %}>
                                    {{ s|capitalize }}
                                </label>
                                {% endfor %}
                            </div>
                            <p class="text-muted small">Les statuts "En cours" et "Terminé" sont automatiques selon les
                                dates.</p>
                            <button type="submit" class="btn btn-primary">Mettre à jour</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Dates Tab (Organizer only) -->
            <div class="tab-pane fade" id="list-dates" role="tabpanel">
                <div class="card">
                    <div class="card-header">Modifier les dates</div>
                    <div class="card-body">
                        <form method="POST" action="/event/{{ event.id }}/update_dates">
                            <div class="mb-3">
                                <label class="form-label">Date de début</label>
                                <input type="date" class="form-control" name="date_start"
                                    value="{{ event.date_start.strftime('%Y-%m-%d') }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date de fin</label>
                                <input type="date" class="form-control" name="date_end"
                                    value="{{ event.date_end.strftime('%Y-%m-%d') }}" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre à jour</button>
                        </form>
                    </div>
                </div>
            </div>

            <script>
                function toggleTitleEdit() {
                    const display = document.getElementById('title-display');
                    const edit = document.getElementById('title-edit');
                    if (display.style.display === 'none') {
                        display.style.display = 'block';
                        edit.style.display = 'none';
                    } else {
                        display.style.display = 'none';
                        edit.style.display = 'block';
                    }
                }
            </script>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}