{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìä Logs d'Activit√©</h2>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Retour au Dashboard</a>
    </div>

    {% if logs %}
    <div class="mb-3">
        <button id="markViewedBtn" class="btn btn-primary">
            <i class="bi bi-check-all"></i> Marquer tout comme vu
        </button>
        <span class="ms-3 text-muted">
            <span class="badge bg-warning text-dark">‚óè</span> = Nouveau
        </span>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th style="width: 15%">Date & Heure</th>
                    <th style="width: 15%">Type</th>
                    <th style="width: 25%">Utilisateur</th>
                    <th style="width: 45%">D√©tails</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr {% if not log.is_viewed %}class="table-warning" {% endif %}>
                    <td>
                        <small>{{ log.created_at.strftime('%d/%m/%Y') }}</small><br>
                        <small class="text-muted">{{ log.created_at.strftime('%H:%M:%S') }}</small>
                    </td>
                    <td>
                        {% if log.action_type == 'user_registration' %}
                        <span class="badge bg-success">
                            <i class="bi bi-person-plus"></i> Inscription
                        </span>
                        {% elif log.action_type == 'event_creation' %}
                        <span class="badge bg-info">
                            <i class="bi bi-calendar-plus"></i> Cr√©ation √©v√©nement
                        </span>
                        {% elif log.action_type == 'event_participation' %}
                        <span class="badge bg-primary">
                            <i class="bi bi-people"></i> Demande participation
                        </span>
                        {% elif log.action_type == 'Modification statut' %}
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-arrow-repeat"></i> Changement statut
                        </span>
                        {% elif log.action_type == 'Suppression utilisateur' %}
                        <span class="badge bg-danger">
                            <i class="bi bi-person-x"></i> Suppression user
                        </span>
                        {% elif log.action_type == 'Mise √† jour √©v√©nement' %}
                        <span class="badge bg-info text-dark">
                            <i class="bi bi-pencil"></i> Modif. √©v√©nement
                        </span>
                        {% elif log.action_type == 'Mise √† jour participant' %}
                        <span class="badge bg-info text-dark">
                            <i class="bi bi-person-gear"></i> Modif. participant
                        </span>
                        {% elif log.action_type == 'Mise √† jour groupes' %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-collection"></i> Config. groupes
                        </span>
                        {% elif log.action_type == 'Mise √† jour utilisateur' %}
                        <span class="badge bg-info text-dark">
                            <i class="bi bi-person-gear"></i> Modif. user
                        </span>
                        {% elif log.action_type == 'Suppression √©v√©nement' %}
                        <span class="badge bg-danger">
                            <i class="bi bi-trash"></i> Suppression √©v√©nement
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.user %}
                        <strong>{{ log.user.email }}</strong>
                        {% if log.user.prenom and log.user.nom %}
                        <br><small class="text-muted">{{ log.user.prenom }} {{ log.user.nom }}</small>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">Utilisateur supprim√©</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.action_type == 'user_registration' %}
                        <div>
                            <strong>{{ log.details_dict.prenom }} {{ log.details_dict.nom }}</strong>
                        </div>
                        <small class="text-muted">
                            Email: {{ log.details_dict.email }}
                            {% if log.details_dict.genre %}
                            | Genre: {{ log.details_dict.genre }}
                            {% endif %}
                        </small>
                        {% elif log.action_type == 'event_creation' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                        </div>
                        <small class="text-muted">
                            Lieu: {{ log.details_dict.location }}
                            | Du {{ log.details_dict.date_start }} au {{ log.details_dict.date_end }}
                        </small>
                        {% elif log.action_type == 'event_participation' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                        </div>
                        <small class="text-muted">
                            Type: <span class="badge bg-secondary">{{ log.details_dict.type }}</span>
                            {% if log.details_dict.group and log.details_dict.group != 'Aucun' %}
                            | Groupe: <span class="badge bg-secondary">{{ log.details_dict.group }}</span>
                            {% endif %}
                        </small>
                        {% elif log.action_type == 'Modification statut' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                            {% if log.details_dict.participant_email %}
                            <br><small class="text-muted">Participant: {{ log.details_dict.participant_email }}</small>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {{ log.details_dict.old_status }} <i class="bi bi-arrow-right"></i> {{
                            log.details_dict.new_status }}
                            {% if log.details_dict.changed_by %}
                            <br>Par: {{ log.details_dict.changed_by }}
                            {% endif %}
                        </small>
                        {% elif log.action_type == 'Suppression utilisateur' %}
                        <div>
                            <strong>{{ log.details_dict.target_email }}</strong>
                        </div>
                        <small class="text-muted">
                            Nom: {{ log.details_dict.name }}
                        </small>
                        {% elif log.action_type == 'Mise √† jour √©v√©nement' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                        </div>
                        <small class="text-muted">
                            Champs modifi√©s: {{ log.details_dict.updated_fields }}
                        </small>
                        {% elif log.action_type == 'Mise √† jour participant' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                        </div>
                        <small class="text-muted">
                            Participant: {{ log.details_dict.target_user_email }}<br>
                            Action: {{ log.details_dict.updated_fields }}
                        </small>
                        {% elif log.action_type == 'Mise √† jour groupes' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                        </div>
                        <small class="text-muted">
                            Configuration des groupes mise √† jour
                        </small>
                        {% elif log.action_type == 'Mise √† jour utilisateur' %}
                        <div>
                            <strong>{{ log.details_dict.target_email }}</strong>
                        </div>
                        <small class="text-muted">
                            Champs modifi√©s: {{ log.details_dict.updated_fields }}
                        </small>
                        {% elif log.action_type == 'Suppression √©v√©nement' %}
                        <div>
                            <strong>{{ log.details_dict.event_name }}</strong>
                        </div>
                        <small class="text-muted">
                            Supprim√© par: {{ log.details_dict.deleted_by_email }}
                        </small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Aucune activit√© enregistr√©e pour le moment.
    </div>
    {% endif %}
</div>

<script>
    document.getElementById('markViewedBtn').addEventListener('click', function () {
        if (confirm('Marquer tous les logs comme consult√©s ?')) {
            fetch('{{ url_for("admin.mark_logs_viewed") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la mise √† jour des logs');
                });
        }
    });
</script>
{% endblock %}